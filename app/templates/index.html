<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Resource Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Team Overview Styles */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .team-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s;
            position: relative;
        }

        .team-card:hover {
            transform: translateY(-4px);
        }

        .team-card:hover .delete-member-btn {
            opacity: 1;
        }

        .delete-member-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f5576c;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
        }

        .delete-member-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .edit-member-btn {
            position: absolute;
            top: 10px;
            right: 45px;
            background: #667eea;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
        }

        .edit-member-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .team-card:hover .edit-member-btn {
            opacity: 1;
        }

        .team-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .team-info h3 {
            font-size: 18px;
            color: #333;
        }

        .role {
            color: #666;
            font-size: 14px;
        }

        .skills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .skill-tag {
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }

        .workload {
            margin-top: 15px;
        }

        .workload-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .workload-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .workload-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .workload-fill.high {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }

        /* Projects Styles */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .project-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s;
            position: relative;
        }

        .project-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        }

        .star-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 20;
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: #bbb;
            transition: color 0.15s;
            padding: 4px;
        }
        .star-btn.starred {
            color: #ffb400;
            text-shadow: 0 1px 0 rgba(0,0,0,0.1);
        }

        .project-card:hover .delete-project-btn {
            opacity: 1;
        }

        .delete-project-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            background: #f5576c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
            z-index: 30;
        }

        .delete-project-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .edit-project-btn {
            position: absolute;
            top: 12px;
            left: 52px;
            background: #667eea;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
            z-index: 30;
        }

        .edit-project-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .project-card:hover .edit-project-btn {
            opacity: 1;
        }

        .project-image-container {
            width: 100%;
            min-height: 150px;
            background: #f5f7fa;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }

        .project-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            padding: 10px;
        }

        .project-image-item {
            position: relative;
            width: 100%;
            height: 120px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .project-image-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .project-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .project-image-placeholder {
            color: #999;
            font-size: 14px;
            text-align: center;
            padding: 40px 20px;
        }

        .project-add-image-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 120px;
            background: #e8eaf0;
            border: 2px dashed #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            color: #667eea;
            font-size: 13px;
            font-weight: 600;
        }

        .project-add-image-btn:hover {
            background: #d8dae8;
            border-color: #5568d3;
        }

        .remove-single-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f5576c;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
            z-index: 10;
        }

        .project-image-item:hover .remove-single-image-btn {
            opacity: 1;
        }

        .remove-single-image-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-close:hover {
            background: #f0f0f0;
        }

        .project-image-upload-btn:hover {
            background: #5568d3;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .project-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .project-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .project-status:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-planning {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-on-hold {
            background: #f8d7da;
            color: #721c24;
        }

        .project-team {
            margin-top: 15px;
        }

        .project-team-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .team-members {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .member-tag {
            background: #f5f7fa;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .member-tag .remove-btn {
            cursor: pointer;
            color: #999;
            font-weight: bold;
        }

        .member-tag .remove-btn:hover {
            color: #f5576c;
        }

        .assign-member-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }

        .assign-member-btn:hover {
            background: #5568d3;
        }

        .team-card.dragging {
            opacity: 0.5;
        }

        .project-card.drag-over {
            border-color: #667eea;
            background: #f5f7fa;
        }

        /* Channel Badges */
        .channel-container {
            margin: 10px 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .channel-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }

        .channel-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .channel-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .channel-badge.selected {
            border-color: currentColor;
            font-weight: 600;
        }

        .channel-badge.agent {
            background: #e3f2fd;
            color: #1976d2;
        }

        .channel-badge.agent.selected {
            background: #1976d2;
            color: white;
        }

        .channel-badge.partnership,
        .channel-badge.non-agent {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .channel-badge.partnership.selected,
        .channel-badge.non-agent.selected {
            background: #7b1fa2;
            color: white;
        }

        .channel-badge.direct-marketing {
            background: #e8f5e9;
            color: #388e3c;
        }

        .channel-badge.direct-marketing.selected {
            background: #388e3c;
            color: white;
        }

        .channel-badge .remove-channel {
            margin-left: 4px;
            font-weight: bold;
            opacity: 0.7;
        }

        .channel-badge .remove-channel:hover {
            opacity: 1;
        }

        /* Application Badges */
        .application-container {
            margin: 10px 0;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .application-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }

        .application-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1.5px solid transparent;
            white-space: nowrap;
        }

        .application-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .application-badge.selected {
            border-color: currentColor;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        /* Individual application colors */
        .app-tl-pro-plus { background: #fff3e0; color: #e65100; }
        .app-tl-pro-plus.selected { background: #e65100; color: white; }

        .app-tl-team-plus { background: #fce4ec; color: #c2185b; }
        .app-tl-team-plus.selected { background: #c2185b; color: white; }

        .app-tl-after-plus { background: #f3e5f5; color: #7b1fa2; }
        .app-tl-after-plus.selected { background: #7b1fa2; color: white; }

        .app-new-da { background: #e8f5e9; color: #2e7d32; }
        .app-new-da.selected { background: #2e7d32; color: white; }

        .app-e-selling { background: #e1f5fe; color: #0277bd; }
        .app-e-selling.selected { background: #0277bd; color: white; }

        .app-e-portal { background: #e0f2f1; color: #00695c; }
        .app-e-portal.selected { background: #00695c; color: white; }

        .app-nsp { background: #fff9c4; color: #f57f17; }
        .app-nsp.selected { background: #f57f17; color: white; }

        .app-tl-smart { background: #e8eaf6; color: #3f51b5; }
        .app-tl-smart.selected { background: #3f51b5; color: white; }

        .app-common { background: #eeeeee; color: #424242; }
        .app-common.selected { background: #424242; color: white; }

        .app-dfl { background: #fbe9e7; color: #bf360c; }
        .app-dfl.selected { background: #bf360c; color: white; }

        .application-badge .remove-app {
            margin-left: 3px;
            font-weight: bold;
            opacity: 0.7;
            font-size: 13px;
        }

        .application-badge .remove-app:hover {
            opacity: 1;
        }

        /* Dashboard Styles */
        .dashboard-channel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .dashboard-channel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .dashboard-channel-header:hover {
            background: #e9ecef;
        }

        .dashboard-channel-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-application {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            margin-left: 20px;
            border-left: 4px solid #48bb78;
        }

        .dashboard-application-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 8px;
            background: white;
            border-radius: 6px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .dashboard-application-header:hover {
            background: #f1f5f9;
        }

        .dashboard-application-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a365d;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-project {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            margin-left: 20px;
            border-left: 3px solid #ed8936;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .dashboard-project-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 6px;
            background: #fffaf0;
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .dashboard-project-header:hover {
            background: #feebc8;
        }

        .dashboard-project-title {
            font-size: 15px;
            font-weight: 600;
            color: #744210;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dashboard-task {
            background: #f7fafc;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            margin-left: 20px;
            border-left: 2px solid #cbd5e0;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .dashboard-task:hover {
            background: #edf2f7;
            border-left-color: #667eea;
        }

        .dashboard-task.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .dashboard-task-icon {
            font-size: 16px;
        }

        .dashboard-task-text {
            flex: 1;
            font-size: 14px;
            color: #2d3748;
        }

        .dashboard-task-assignee {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .dashboard-task-dates {
            font-size: 11px;
            color: #718096;
        }

        .dashboard-count {
            background: #e0e7ff;
            color: #5a67d8;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .dashboard-expand-icon {
            font-size: 18px;
            color: #a0aec0;
            transition: transform 0.2s;
        }

        .dashboard-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .dashboard-empty {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
            font-size: 16px;
        }

        /* Master Timeline */
        .master-timeline {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .master-timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .master-timeline-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .master-timeline-grid {
            display: grid;
            grid-template-columns: 300px repeat(53, 1fr); /* Max 53 weeks per year */
            gap: 1px;
            margin-top: 15px;
        }

        .master-timeline-header-cell {
            text-align: center;
            font-size: 9px;
            font-weight: 700;
            color: #4a5568;
            padding: 6px 2px;
            background: #edf2f7;
            border-radius: 3px;
        }

        .master-timeline-month-header {
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: #2d3748;
            padding: 8px 4px;
            background: #cbd5e0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .master-timeline-row-header {
            font-size: 12px;
            font-weight: 600;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f7fafc;
            border-radius: 4px;
        }

        .master-timeline-channel {
            background: #e6f2ff;
            color: #0066cc;
        }

        .master-timeline-app {
            background: #f0f4ff;
            color: #5a67d8;
            padding-left: 20px;
        }

        .master-timeline-project {
            background: #fff5f0;
            color: #c05621;
            padding-left: 40px;
        }

        .master-timeline-task {
            background: #fafafa;
            color: #4a5568;
            padding-left: 60px;
            font-size: 11px;
        }

        .clickable-project-name {
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .clickable-project-name:hover {
            background: #667eea;
            color: white;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .master-timeline-cell {
            min-height: 35px;
            background: #fafafa;
            border-radius: 3px;
            position: relative;
            border: 1px solid #e2e8f0;
        }

        .no-date-indicator {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #cbd5e0;
            font-size: 14px;
            cursor: help;
            opacity: 0.6;
        }

        .master-timeline-bar {
            position: absolute;
            height: 80%;
            top: 10%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            opacity: 0.85;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .master-timeline-bar:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            z-index: 10;
        }

        .master-timeline-bar.completed {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .master-timeline-bar.overdue {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .master-timeline-today-marker {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 100%;
            background: #ed8936;
            z-index: 5;
            pointer-events: none;
        }

        .master-timeline-today-marker::before {
            content: '▼';
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #ed8936;
            font-weight: bold;
        }

        .master-timeline-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
            font-size: 12px;
            flex-wrap: wrap;
        }

        .master-timeline-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .master-timeline-legend-box {
            width: 24px;
            height: 14px;
            border-radius: 3px;
        }

        /* Project Timeline */
        .project-timeline {
            margin: 15px 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .timeline-year {
            font-size: 14px;
            font-weight: 700;
            color: #2d3748;
        }

        .timeline-grid {
            display: grid;
            grid-template-columns: 80px repeat(12, 1fr);
            gap: 2px;
            margin-top: 10px;
        }

        .timeline-label {
            font-size: 11px;
            font-weight: 600;
            color: #718096;
            padding: 8px 4px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .timeline-month {
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: #4a5568;
            padding: 5px 2px;
            background: #f7fafc;
            border-radius: 4px 4px 0 0;
        }

        .timeline-cell {
            min-height: 30px;
            background: #f7fafc;
            border-radius: 4px;
            position: relative;
            border: 1px solid #e2e8f0;
        }

        .timeline-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            top: 0;
            opacity: 0.8;
            transition: opacity 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .timeline-bar:hover {
            opacity: 1;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .timeline-bar.completed {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .timeline-bar.overdue {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .timeline-bar-label {
            font-size: 9px;
            color: white;
            font-weight: 600;
            padding: 0 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .timeline-today {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ed8936;
            z-index: 10;
            pointer-events: none;
        }

        .timeline-today::before {
            content: '▼';
            position: absolute;
            top: -15px;
            left: -5px;
            font-size: 10px;
            color: #ed8936;
        }

        .timeline-legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
            font-size: 11px;
        }

        .timeline-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timeline-legend-box {
            width: 20px;
            height: 12px;
            border-radius: 3px;
        }

        /* Availability Calendar */
        .calendar {
            margin-top: 20px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .calendar-day {
            text-align: center;
            font-weight: 600;
            color: #666;
            font-size: 14px;
            padding: 10px;
        }

        .calendar-row {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .calendar-name {
            padding: 10px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
        }

        .calendar-cell {
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-cell.available {
            background: #d4edda;
            color: #155724;
        }

        .calendar-cell.busy {
            background: #f8d7da;
            color: #721c24;
        }

        .calendar-cell.partial {
            background: #fff3cd;
            color: #856404;
        }

        .calendar-cell:hover {
            transform: scale(1.05);
        }

        /* Calendar View Styles */
        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .calendar-week-header {
            font-weight: 600;
            text-align: center;
            color: #667eea;
            padding: 10px;
            border-bottom: 2px solid #667eea;
        }

        .calendar-day-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        .calendar-day-card.other-month {
            background: #f9f9f9;
            opacity: 0.6;
        }

        .calendar-day-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        }

        .calendar-day-header {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 8px;
        }

        .calendar-day-header.today {
            background: #667eea;
            color: white;
            padding: 6px 8px;
            margin: -12px -12px 8px -12px;
            border-radius: 12px 12px 0 0;
            border-bottom: none;
        }

        .calendar-day-header.weekend {
            color: #e74c3c;
        }

        .calendar-day-tasks {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            overflow-y: auto;
        }

        .calendar-task-item {
            background: #f8f9fa;
            padding: 6px 8px;
            border-left: 3px solid #667eea;
            border-radius: 3px;
            font-size: 11px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .calendar-task-item:hover {
            background: #e3e8ff;
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            border-left-width: 4px;
        }

        .calendar-task-item.completed {
            background: #e8f5e9;
            border-left-color: #4caf50;
            opacity: 0.7;
        }

        .calendar-task-item.overdue {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .calendar-task-item.completed .calendar-task-text {
            text-decoration: line-through;
            color: #999;
        }

        .calendar-task-text {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            word-break: break-word;
        }

        .calendar-task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: #666;
            margin-top: 2px;
            flex-wrap: wrap;
            gap: 3px;
        }

        .calendar-task-project {
            background: #e3f2fd;
            color: #1976d2;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
        }

        .calendar-task-assignee {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
        }

        .calendar-no-tasks {
            color: #999;
            font-size: 12px;
            text-align: center;
            padding: 10px 5px;
        }

        .calendar-empty-message {
            grid-column: 1 / -1;
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 16px;
        }

        /* Add Resource Button */
        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .add-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .export-import-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .export-btn, .import-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .import-btn {
            background: #17a2b8;
        }

        .import-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        #importFile {
            display: none;
        }

        /* Task Overview Dashboard */
        .member-overview-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .member-overview-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        }

        .member-overview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .member-overview-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .member-overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box.done {
            background: linear-gradient(135deg, #d4edda 0%, #a8d5ba 100%);
        }

        .stat-box.onplan {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        }

        .stat-box.delayed {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }

        .task-detail-section {
            margin-top: 15px;
        }

        .task-detail-header {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f5f7fa;
            border-radius: 6px;
        }

        .task-detail-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-detail-item {
            background: #fafafa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
            cursor: pointer;
        }

        .task-detail-item:hover {
            background: #e8eeff;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            border-left-width: 5px;
        }

        .task-detail-item.done {
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .task-detail-item.delayed {
            border-left-color: #dc3545;
        }

        .task-detail-item.onplan {
            border-left-color: #ffc107;
        }

        .task-detail-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .task-detail-title.completed {
            text-decoration: line-through;
            color: #999;
        }

        .task-detail-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
            flex-wrap: wrap;
        }

        .task-detail-meta span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .no-tasks-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .task-monitor-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-group {
            flex: 1;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .filter-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-select:hover {
            border-color: #667eea;
        }

        .clear-filter-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 24px;
        }

        .clear-filter-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .task-edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .task-edit-modal.active {
            display: flex;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .status-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 100;
            margin-top: 5px;
            min-width: 150px;
        }

        .status-option {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .status-option:hover {
            background: #f5f7fa;
        }

        .status-option:first-child {
            border-radius: 6px 6px 0 0;
        }

        .status-option:last-child {
            border-radius: 0 0 6px 6px;
        }

        .tasks-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tasks-label {
            font-size: 13px;
            color: #666;
            font-weight: 600;
        }

        .add-task-btn {
            background: transparent;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-task-btn:hover {
            background: #667eea;
            color: white;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: #f0f0f0;
        }

        .task-item:hover .task-assignee-btn {
            opacity: 1;
        }

        .task-assignee {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .task-assignee:hover {
            background: #5568d3;
        }

        .task-assignee-btn {
            background: #e0e0e0;
            color: #666;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .task-assignee-btn:hover {
            background: #667eea;
            color: white;
            opacity: 1;
        }

        .assignee-dropdown {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 180px;
            max-height: 200px;
            overflow-y: auto;
        }

        .assignee-option {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .assignee-option:hover {
            background: #f5f7fa;
        }

        .assignee-option .role-badge {
            font-size: 10px;
            color: #999;
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .task-text {
            flex: 1;
            color: #333;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: #999;
        }

        .task-dates {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: #666;
            align-items: center;
        }

        .task-date {
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .task-date.overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .task-date-input {
            padding: 4px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .task-date-input:hover {
            border-color: #667eea;
        }

        .date-picker-popup {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 250px;
        }

        .date-picker-header {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .date-picker-group {
            margin-bottom: 10px;
        }

        .date-picker-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .date-picker-input {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
        }

        .date-picker-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .date-picker-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .date-picker-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .date-picker-btn.save {
            background: #667eea;
            color: white;
        }

        .date-picker-btn.save:hover {
            background: #5568d3;
        }

        .date-picker-btn.cancel {
            background: #e0e0e0;
            color: #666;
        }

        .date-picker-btn.cancel:hover {
            background: #d0d0d0;
        }

        .task-delete {
            color: #999;
            cursor: pointer;
            font-size: 16px;
            padding: 0 5px;
        }

        .task-delete:hover {
            color: #f5576c;
        }

        .task-edit {
            color: #999;
            cursor: pointer;
            font-size: 14px;
            padding: 0 5px;
        }

        .task-edit:hover {
            color: #667eea;
        }

        .task-input-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .task-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
        }

        .task-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .task-add-confirm {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        .task-add-confirm:hover {
            background: #5568d3;
        }

        .no-tasks {
            color: #999;
            font-size: 13px;
            font-style: italic;
            padding: 8px;
        }

        /* Subtask Styles */
        .subtasks-container {
            margin-left: 30px;
            margin-top: 8px;
            border-left: 2px solid #e0e0e0;
            padding-left: 12px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .subtask-item:hover {
            background: #e8e8e8;
        }

        .subtask-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .subtask-text {
            flex: 1;
            color: #666;
        }

        .subtask-text.completed {
            text-decoration: line-through;
            color: #999;
        }

        .subtask-delete {
            color: #999;
            cursor: pointer;
            font-size: 14px;
            padding: 0 4px;
            opacity: 0.7;
        }

        .subtask-delete:hover {
            color: #f5576c;
            opacity: 1;
        }

        .subtask-edit {
            color: #999;
            cursor: pointer;
            font-size: 12px;
            padding: 0 4px;
            opacity: 0.7;
        }

        .subtask-edit:hover {
            color: #667eea;
            opacity: 1;
        }

        .add-subtask-btn {
            background: transparent;
            color: #667eea;
            border: 1px dotted #667eea;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 30px;
            margin-top: 4px;
        }

        .add-subtask-btn:hover {
            background: #f5f7fa;
            border-style: solid;
        }

        .subtask-input-container {
            display: flex;
            gap: 6px;
            margin-left: 30px;
            margin-top: 4px;
        }

        .subtask-input {
            flex: 1;
            padding: 6px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
        }

        .subtask-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .subtask-confirm {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .subtask-confirm:hover {
            background: #5568d3;
        }

        .subtasks-progress {
            font-size: 10px;
            color: #999;
            margin-left: 30px;
            margin-top: 2px;
        }

        .subtask-assignee {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .subtask-assignee:hover {
            background: #5568d3;
        }

        .subtask-assignee-btn {
            background: #e0e0e0;
            color: #666;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .subtask-assignee-btn:hover {
            background: #667eea;
            color: white;
            opacity: 1;
        }

        .project-links {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .project-meeting-minutes {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .meeting-minutes-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meeting-minutes-content {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            font-size: 13px;
            color: #333;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .meeting-minutes-edit {
            margin-top: 10px;
        }

        .meeting-minutes-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            font-family: inherit;
        }

        .meeting-minutes-empty {
            color: #999;
            font-style: italic;
            padding: 12px;
        }

        .project-links-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .links-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .link-item {
            background: #f9f9f9;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .link-item:hover {
            background: #f0f0f0;
        }

        .link-text {
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: color 0.2s;
        }

        .link-text:hover {
            color: #5568d3;
            text-decoration: underline;
        }

        .remove-link-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin-left: 10px;
            transition: color 0.2s;
        }

        .remove-link-btn:hover {
            color: #f5576c;
        }

        .add-link-input-container {
            background: #f5f7fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .link-title-input,
        .link-url-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .link-title-input:focus,
        .link-url-input:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
    <script>
        function exportTaskOverviewPDF() {
            const member = document.getElementById('memberFilter') ? document.getElementById('memberFilter').value : '';
            const status = document.getElementById('statusFilter') ? document.getElementById('statusFilter').value : '';
            const project = document.getElementById('projectFilter') ? document.getElementById('projectFilter').value : '';
            const title = 'Team Task Overview';
            const filtersSummary = `Filters: ${member || 'All members'} | ${status || 'All statuses'} | ${project || 'All projects'}`;
            const contentEl = document.getElementById('taskOverview');
            if (!contentEl) {
                alert('Nothing to export');
                return;
            }
            const contentHtml = contentEl.innerHTML;
            const style = `
                <style>
                    body{font-family: Arial, Helvetica, sans-serif; color:#222; padding:20px}
                    h1{font-size:20px; margin-bottom:6px}
                    .filters-summary{font-size:12px; color:#555; margin-bottom:12px}
                    .member-overview-card{margin-bottom:14px; border-bottom:1px solid #e8e8e8; padding-bottom:10px}
                    .task-detail-item{margin:6px 0}
                </style>`;

            const win = window.open('', '_blank');
            win.document.write(`<!doctype html><html><head><meta charset="utf-8">${style}</head><body><h1>${title}</h1><div class="filters-summary">${filtersSummary}</div>${contentHtml}</body></html>`);
            win.document.close();
            win.focus();
            // Give the new window a moment to render then open print dialog
            setTimeout(() => {
                win.print();
                // try to close window after print dialog (may be blocked by some browsers)
                setTimeout(() => win.close(), 700);
            }, 250);
        }
    </script>
    
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>🚀 IT Resource Manager</h1>
            <p class="subtitle">Manage your development team, projects, and resource allocation</p>
            <div class="tabs">
                <button class="tab" onclick="switchTab('team')">Team Overview</button>
                <button class="tab" onclick="switchTab('projects')">Projects</button>
                <button class="tab active" onclick="switchTab('dashboard')">📊 Dashboard</button>
                <button class="tab" id="taskMonitorTab" onclick="switchTab('availability')" style="display: none;">Task Monitor</button>
                <button class="tab" id="calendarTab" onclick="switchTab('calendar')" style="display: none;">📅 Calendar</button>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 8px; display: inline-flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="showAdvancedMenus" onchange="toggleAdvancedMenus()" style="width: 18px; height: 18px; cursor: pointer;">
                <label for="showAdvancedMenus" style="cursor: pointer; font-size: 14px; font-weight: 500; color: #4a5568;">Show Advanced Menus (Task Monitor, Calendar)</label>
            </div>
        </header>

        <div class="content">
            <!-- Team Overview Tab -->
            <div id="team" class="tab-content">
                <button class="add-btn" onclick="addTeamMember()">+ Add Team Member</button>
                <div class="team-grid" id="teamGrid"></div>
            </div>

            <!-- Projects Tab -->
            <div id="projects" class="tab-content">
                <button class="add-btn" onclick="addProject()">+ Add Project</button>
                <div class="task-monitor-controls" style="margin-bottom: 20px;">
                    <div class="filter-group">
                        <div class="filter-label">Search by Project Name</div>
                        <input type="text" class="filter-select" id="projectSearchInput" placeholder="Type project name..." oninput="renderProjects()" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Filter by Status</div>
                        <select class="filter-select" id="projectStatusFilter" onchange="renderProjects()">
                            <option value="">All Statuses</option>
                            <option value="planning">📋 Planning</option>
                            <option value="active">🚀 Active</option>
                            <option value="on-hold">⏸️ On Hold</option>
                            <option value="completed">✅ Completed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Filter by Team Member</div>
                        <select class="filter-select" id="projectMemberFilter" onchange="renderProjects()">
                            <option value="">All Team Members</option>
                        </select>
                    </div>
                    <button class="clear-filter-btn" onclick="clearProjectFilters()">Clear Filters</button>
                </div>
                <div class="projects-grid" id="projectsGrid"></div>
            </div>

            <!-- Availability Tab -->
            <div id="availability" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">Team Task Overview</h2>
                <div class="task-monitor-controls">
                    <div class="filter-group">
                        <div class="filter-label">Filter by Team Member</div>
                        <select class="filter-select" id="memberFilter" onchange="renderTaskOverview()">
                            <option value="">All Team Members</option>
                            <option value="unassigned">🔴 Unassigned Tasks</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Filter by Status</div>
                        <select class="filter-select" id="statusFilter" onchange="renderTaskOverview()">
                            <option value="">All Statuses</option>
                            <option value="delayed">⚠️ Delayed Only</option>
                            <option value="onplan">📅 On Plan Only</option>
                            <option value="done">✅ Done Only</option>
                            <option value="nodate">📭 No Start Date</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Filter by Project</div>
                        <select class="filter-select" id="projectFilter" onchange="renderTaskOverview()">
                            <option value="">All Projects</option>
                        </select>
                    </div>
                    <button class="clear-filter-btn" onclick="clearFilters()">Clear Filters</button>
                    <button class="export-btn" onclick="exportTaskOverviewPDF()">Export PDF</button>
                </div>
                <div id="taskOverview"></div>
            </div>

            <!-- Calendar Tab -->
            <div id="calendar" class="tab-content">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <button class="clear-filter-btn" onclick="previousMonth()" style="background: #667eea; color: white; padding: 10px 15px;">← Previous</button>
                        <h2 id="calendarMonthYear" style="flex: 1; text-align: center; color: #333; margin: 0;"></h2>
                        <button class="clear-filter-btn" onclick="nextMonth()" style="background: #667eea; color: white; padding: 10px 15px;">Next →</button>
                    </div>
                    <div class="task-monitor-controls">
                        <div class="filter-group">
                            <div class="filter-label">Filter by Project</div>
                            <select class="filter-select" id="calendarProjectFilter" onchange="renderCalendarView()">
                                <option value="">All Projects</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <div class="filter-label">Filter by Team Member</div>
                            <select class="filter-select" id="calendarMemberFilter" onchange="renderCalendarView()">
                                <option value="">All Team Members</option>
                            </select>
                        </div>
                        <button class="clear-filter-btn" onclick="clearCalendarFilters()">Clear Filters</button>
                    </div>
                </div>
                <div class="calendar-view" id="calendarView"></div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard" class="tab-content active">
                <div style="margin-bottom: 20px;">
                    <h2 style="margin-bottom: 10px;">📊 Project Dashboard</h2>
                    <p style="color: #666; margin-bottom: 20px;">Channel → Application → Project → Task hierarchy</p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="export-btn" onclick="exportDashboardPDF()" style="background: #667eea;">
                            📄 Export Dashboard PDF
                        </button>
                        <button class="export-btn" onclick="expandAllDashboard()" style="background: #48bb78;">
                            ➕ Expand All
                        </button>
                        <button class="export-btn" onclick="collapseAllDashboard()" style="background: #ed8936;">
                            ➖ Collapse All
                        </button>
                    </div>
                </div>
                
                <!-- Master Timeline for All Projects -->
                <div style="margin-bottom: 15px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; font-size: 18px; color: #2d3748;">📅 Master Project Timeline (Weekly View)</h3>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600; color: #4a5568;">Filter by Assignee:</label>
                            <select id="timelineAssigneeFilter" onchange="renderMasterTimeline()" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; font-size: 14px; cursor: pointer;">
                                <option value="all">All Assignees</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600; color: #4a5568;">Completed in Month:</label>
                            <select id="timelineCompletedMonthFilter" onchange="renderMasterTimeline()" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; font-size: 14px; cursor: pointer;">
                                <option value="all">All Months</option>
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="masterTimeline"></div>
                
                <div id="dashboardView"></div>
            </div>
        </div>
    </div>

    <!-- Add Team Member Modal -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="teamModalHeader">Add Team Member</div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="memberName" placeholder="Enter name">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="memberRole">
                    <option>Developer</option>
                    <option>System Analyst</option>
                    <option>Business Analyst</option>
                    <option>Tester</option>
                    <option>DevOps</option>
                    <option>UI/UX Designer</option>
                    <option>Project Coordinator</option>
                </select>
            </div>
            <div class="form-group">
                <label>Skills (comma-separated)</label>
                <input type="text" id="memberSkills" placeholder="React, Node.js, Python">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="teamModalSaveBtn" onclick="saveTeamMember()">Add Member</button>
                <button class="btn btn-secondary" onclick="closeModal('team')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="projectModalHeader">Add Project</div>
            <div class="form-group">
                <label>Project Name</label>
                <input type="text" id="projectName" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="projectStatus">
                    <option value="planning">Planning</option>
                    <option value="active">Active</option>
                    <option value="on-hold">On Hold</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="projectDesc" placeholder="Brief description">
            </div>
            <div class="form-group">
                <label>Meeting Minutes (optional)</label>
                <textarea id="projectMeetingMinutes" placeholder="Add meeting notes, decisions, action items, etc." style="width: 100%; height: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label>Project Images (optional)</label>
                <input type="file" id="projectImage" accept="image/*" multiple style="font-size: 13px;">
                <div style="font-size: 11px; color: #999; margin-top: 5px;">Upload multiple images - logos, screenshots, mockups, etc.</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="projectModalSaveBtn" onclick="saveProject()">Add Project</button>
                <button class="btn btn-secondary" onclick="closeModal('project')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Assign Member Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Assign Member to <span id="assignProjectName"></span></div>
            <div class="form-group">
                <label>Select Team Member</label>
                <select id="assignMemberSelect">
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="assignMemberToProject()">Assign</button>
                <button class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="taskEditModal" class="task-edit-modal">
        <div class="modal-content">
            <div class="modal-header">Edit Task</div>
            <div class="form-group">
                <label>Task Description</label>
                <input type="text" id="editTaskText" placeholder="Enter task description">
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="editTaskStartDate">
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="editTaskEndDate">
            </div>
            <div class="form-group">
                <label>Assign To</label>
                <select id="editTaskAssignee">
                    <option value="">Unassigned</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveTaskEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeTaskEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Subtask Modal -->
    <div id="subtaskEditModal" class="task-edit-modal">
        <div class="modal-content">
            <div class="modal-header">Edit Subtask</div>
            <div class="form-group">
                <label>Subtask Description</label>
                <input type="text" id="editSubtaskText" placeholder="Enter subtask description">
            </div>
            <div class="form-group">
                <label>Assign To</label>
                <select id="editSubtaskAssignee">
                    <option value="">Unassigned</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveSubtaskEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeSubtaskEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Version Info Modal -->
    <div id="versionModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">📋 Version History & Features</div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                <h2 style="margin: 0; font-size: 24px;">Current Version: 2.5.0</h2>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">Released: February 2026</p>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">✨ Latest Features (v2.5.0)</h3>
                <ul style="line-height: 1.8; color: #333;">
                    <li><strong>✏️ Edit Subtasks</strong> - Edit subtask text and reassign team members via modal</li>
                    <li><strong>🔴 Unassigned Tasks Filter</strong> - View all tasks without assignees grouped by project</li>
                    <li><strong>📭 No Start Date Filter</strong> - Find tasks missing start dates for each team member</li>
                    <li><strong>🔗 Clickable Tasks</strong> - Click tasks in Task Monitor to jump to their project</li>
                    <li><strong>📅 Calendar Integration</strong> - Click calendar tasks to navigate to projects</li>
                </ul>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">🎯 Version 2.0.0 - Major Update</h3>
                <ul style="line-height: 1.8; color: #333;">
                    <li><strong>📅 Calendar View</strong> - Full calendar with month navigation and task visualization</li>
                    <li><strong>📊 Task Monitor</strong> - Dashboard showing team member workload and task status</li>
                    <li><strong>🔍 Advanced Filters</strong> - Filter by project, status, team member across all views</li>
                    <li><strong>📈 Progress Tracking</strong> - Visual indicators for delayed, on-plan, and completed tasks</li>
                </ul>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">🔧 Version 1.5.0 - Enhanced Features</h3>
                <ul style="line-height: 1.8; color: #333;">
                    <li><strong>🖼️ Multiple Images</strong> - Upload multiple project images with gallery view</li>
                    <li><strong>✏️ Edit Everything</strong> - Edit team members, projects, and tasks</li>
                    <li><strong>🔗 Project Links</strong> - Add external links to projects</li>
                    <li><strong>📝 Meeting Minutes</strong> - Document meeting notes for each project</li>
                    <li><strong>⭐ Starred Projects</strong> - Mark urgent/important projects</li>
                </ul>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">🎨 Version 1.0.0 - Core Features</h3>
                <ul style="line-height: 1.8; color: #333;">
                    <li><strong>👥 Team Management</strong> - Add, edit, delete team members with roles and skills</li>
                    <li><strong>📁 Project Management</strong> - Create projects with status tracking</li>
                    <li><strong>✅ Task Management</strong> - Tasks with dates, assignees, and completion tracking</li>
                    <li><strong>🔸 Subtasks</strong> - Break down tasks into manageable subtasks</li>
                    <li><strong>🎨 Drag & Drop</strong> - Assign team members to projects via drag-and-drop</li>
                    <li><strong>📊 Workload Calculation</strong> - Automatic workload percentage tracking</li>
                    <li><strong>💾 Export/Import</strong> - JSON export and import for data backup</li>
                    <li><strong>🎯 Assignee Tracking</strong> - Assign tasks to specific team members</li>
                </ul>
            </div>

            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                <h3 style="color: #333; margin: 0 0 10px 0;">📊 System Statistics</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; color: #666;">
                    <div><strong>Total Lines of Code:</strong> 4,480+</div>
                    <div><strong>Total Functions:</strong> 60+</div>
                    <div><strong>CSS Classes:</strong> 150+</div>
                    <div><strong>Features:</strong> 40+</div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeVersionModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageModal" class="image-modal">
        <button class="image-modal-close" onclick="closeImageModal()">×</button>
        <img id="imageModalImg" class="image-modal-content" src="" alt="Project Image">
    </div>

    <script>
        // Sample Data (will be replaced by server data if available)
        let teamMembers = [
            {
                name: "Sarah Chen",
                role: "Developer",
                skills: ["React", "Node.js", "MongoDB"],
                workload: 75,
                projects: ["E-commerce Platform", "Mobile App"]
            },
            {
                name: "Mike Johnson",
                role: "System Analyst",
                skills: ["UML", "Requirements", "Agile"],
                workload: 60,
                projects: ["CRM System"]
            },
            {
                name: "Lisa Wong",
                role: "Tester",
                skills: ["Selenium", "Jest", "QA"],
                workload: 85,
                projects: ["E-commerce Platform", "CRM System"]
            },
            {
                name: "David Park",
                role: "Developer",
                skills: ["Python", "Django", "PostgreSQL"],
                workload: 50,
                projects: ["Mobile App"]
            }
        ];

        // API Configuration
        const API_BASE_URL = window.location.port === '5001' ? 'http://localhost:5001' : '';
        
        // Load data from API on startup
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/data`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.teamMembers) {
                        teamMembers.length = 0;
                        teamMembers.push(...data.teamMembers);
                    }
                    if (data.projects) {
                        projects.length = 0;
                        projects.push(...data.projects);
                    }
                    console.log('✓ Data loaded from server');
                    console.log(`  - Team Members: ${teamMembers.length}`);
                    console.log(`  - Projects: ${projects.length}`);
                    
                    // Only render if we're on the page and functions exist
                    // Don't render calendar on initial load (it will render when tab is clicked)
                    if (typeof renderProjects === 'function') {
                        renderProjects();
                    }
                    if (typeof renderTaskOverview === 'function') {
                        renderTaskOverview();
                    }
                    if (typeof renderDashboard === 'function') {
                        renderDashboard();
                    }
                } else {
                    console.warn('Failed to load data from server, using defaults');
                }
            } catch (error) {
                console.warn('Could not connect to server, using default data:', error.message);
            }
        }

        let projects = [
            {
                name: "E-commerce Platform",
                status: "active",
                description: "Next-gen shopping experience",
                team: ["Sarah Chen", "Lisa Wong"],
                meetingMinutes: "",
                tasks: [
                    { id: 1, text: "Design product page mockups", completed: true, assignee: "Sarah Chen", startDate: "2026-02-01", endDate: "2026-02-05", subtasks: [
                        { text: "Create wireframes", completed: true, assignee: "Sarah Chen" },
                        { text: "Design mockups in Figma", completed: true, assignee: "Sarah Chen" },
                        { text: "Get client feedback", completed: true, assignee: "Lisa Wong" }
                    ] },
                    { id: 2, text: "Implement shopping cart", completed: false, assignee: "Sarah Chen", startDate: "2026-02-08", endDate: "2026-02-15", subtasks: [
                        { text: "Set up cart state management", completed: true, assignee: "Sarah Chen" },
                        { text: "Build cart UI components", completed: true, assignee: "Sarah Chen" },
                        { text: "Implement add/remove items", completed: false, assignee: "Sarah Chen" },
                        { text: "Test cart functionality", completed: false, assignee: "Lisa Wong" }
                    ] },
                    { id: 3, text: "Set up payment gateway", completed: false, assignee: null, startDate: null, endDate: null, subtasks: [] }
                ]
            },
            {
                name: "CRM System",
                status: "active",
                description: "Customer relationship management",
                team: ["Mike Johnson", "Lisa Wong"],
                meetingMinutes: "",
                tasks: [
                    { id: 1, text: "Database schema design", completed: true, assignee: "Mike Johnson", startDate: "2026-01-20", endDate: "2026-01-25", subtasks: [
                        { text: "Define entities and relationships", completed: true, assignee: "Mike Johnson" },
                        { text: "Create ER diagram", completed: true, assignee: "Mike Johnson" },
                        { text: "Review with team", completed: true, assignee: "Lisa Wong" },
                        { text: "Get stakeholder approval", completed: true, assignee: "Lisa Wong" }
                    ] },
                    { id: 2, text: "User authentication module", completed: false, assignee: "Lisa Wong", startDate: "2026-02-10", endDate: "2026-02-20", subtasks: [
                        { text: "Implement login functionality", completed: false, assignee: "Lisa Wong" },
                        { text: "Add password reset feature", completed: false, assignee: "Lisa Wong" },
                        { text: "Set up user session management", completed: false, assignee: "Mike Johnson" }
                    ] }
                ]
            },
            {
                name: "Mobile App",
                status: "planning",
                description: "iOS and Android application",
                team: ["Sarah Chen", "David Park"],
                meetingMinutes: "",
                tasks: []
            }
        ];

        // Calendar state
        let currentCalendarDate = new Date();

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'availability') {
                renderTaskOverview();
            } else if (tabName === 'projects') {
                renderProjects();
            } else if (tabName === 'calendar') {
                renderCalendarView();
            } else if (tabName === 'dashboard') {
                renderDashboard();
            }
        }
        
        function toggleAdvancedMenus() {
            const checkbox = document.getElementById('showAdvancedMenus');
            const taskMonitorTab = document.getElementById('taskMonitorTab');
            const calendarTab = document.getElementById('calendarTab');
            const taskMonitorContent = document.getElementById('availability');
            const calendarContent = document.getElementById('calendar');
            
            if (checkbox.checked) {
                taskMonitorTab.style.display = '';
                calendarTab.style.display = '';
            } else {
                taskMonitorTab.style.display = 'none';
                calendarTab.style.display = 'none';
                
                // If currently viewing Task Monitor or Calendar, switch to Dashboard
                if (taskMonitorContent.classList.contains('active') || calendarContent.classList.contains('active')) {
                    // Switch to dashboard
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    const dashboardTab = document.querySelector('.tab[onclick*="dashboard"]');
                    if (dashboardTab) dashboardTab.classList.add('active');
                    document.getElementById('dashboard').classList.add('active');
                }
            }
        }

        // Navigate to a specific project in Projects tab
        function navigateToProject(projectName) {
            // Switch to Projects tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate Projects tab
            const projectsTab = document.querySelector('.tab[onclick*="projects"]');
            if (projectsTab) projectsTab.classList.add('active');
            document.getElementById('projects').classList.add('active');
            
            // Render projects to ensure the project exists in DOM
            renderProjects();
            
            // Find and scroll to the project card
            setTimeout(() => {
                const projectCard = document.querySelector(`.project-card[data-project="${projectName.replace(/"/g, '\\"')}"]`);
                if (projectCard) {
                    projectCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Add highlight effect
                    projectCard.style.outline = '3px solid #667eea';
                    projectCard.style.outlineOffset = '4px';
                    projectCard.style.transition = 'all 0.3s';
                    setTimeout(() => {
                        projectCard.style.outline = '';
                        projectCard.style.outlineOffset = '';
                    }, 2000);
                }
            }, 100);
        }

        // Modal functions
        function openModal(type) {
            const modal = document.getElementById(type + 'Modal');
            if (modal) {
                modal.classList.add('active');
                // Add click outside to close
                setTimeout(() => {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeModal(type);
                        }
                    });
                }, 100);
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(type + 'Modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Render team members
        function renderTeam() {
            const grid = document.getElementById('teamGrid');
            grid.innerHTML = teamMembers.map((member, index) => `
                <div class="team-card" draggable="true" data-member="${member.name}" data-index="${index}">
                    <button class="edit-member-btn" onclick="editTeamMember(${index})" title="Edit team member">✎</button>
                    <button class="delete-member-btn" onclick="removeTeamMember('${member.name}')" title="Remove team member">×</button>
                    <div class="team-header">
                        <div class="avatar">${member.name.split(' ').map(n => n[0]).join('')}</div>
                        <div class="team-info">
                            <h3>${member.name}</h3>
                            <div class="role">${member.role}</div>
                        </div>
                    </div>
                    <div class="skills">
                        ${member.skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                    </div>
                    <div class="workload">
                        <div class="workload-label">
                            <span>Workload</span>
                            <span>${member.workload}%</span>
                        </div>
                        <div class="workload-bar">
                            <div class="workload-fill ${member.workload > 80 ? 'high' : ''}" style="width: ${member.workload}%"></div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 13px; color: #666;">
                        Projects: ${member.projects.join(', ') || 'None'}
                    </div>
                </div>
            `).join('');

            // Add drag event listeners
            document.querySelectorAll('.team-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
        }

        // Helper function to update project to database
        async function updateProjectToDatabase(project) {
            if (!project.id) {
                console.warn('Project has no ID, cannot update to database');
                return;
            }
            
            try {
                console.log('Updating project to database:', {
                    id: project.id,
                    name: project.name,
                    channels: project.channels,
                    applications: project.applications,
                    taskCount: (project.tasks || []).length
                });
                
                const response = await fetch(`${API_BASE_URL}/api/projects/${project.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: project.name,
                        description: project.description,
                        status: project.status,
                        starred: project.starred,
                        meetingMinutes: project.meetingMinutes || project.meeting_minutes || '',
                        channels: project.channels || [],
                        applications: project.applications || [],
                        deliveryDate: project.deliveryDate || null,
                        tasks: project.tasks || []
                    })
                });
                
                if (response.ok) {
                    const updated = await response.json();
                    console.log('✓ Project updated successfully:', {
                        channels: updated.channels,
                        applications: updated.applications
                    });
                    
                    // Update local project with server response to stay in sync
                    const idx = projects.findIndex(p => p.id === project.id);
                    if (idx >= 0) {
                        // Preserve channels and applications from server response
                        projects[idx].channels = updated.channels || [];
                        projects[idx].applications = updated.applications || [];
                    }
                } else {
                    let errorMessage = 'Failed to update project';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch {
                        errorMessage = await response.text();
                    }
                    console.error('Failed to update project:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorMessage
                    });
                    throw new Error(`Failed to update project: ${errorMessage}`);
                }
            } catch (err) {
                console.error('Error updating project:', err);
                alert(`Failed to update project: ${err.message || 'Please try again.'}`);
            }
        }

        async function toggleStar(projectIndex) {
            const project = projects[projectIndex];
            
            // Check if project has an ID (from database)
            if (!project.id) {
                console.warn('Project has no ID, updating locally only');
                project.starred = !project.starred;
                renderProjects();
                return;
            }
            
            const newVal = !project.starred;
            const oldVal = project.starred;
            
            // Optimistic update
            project.starred = newVal;
            renderProjects();

            try {
                // Persist to server using project ID
                const response = await fetch(`${API_BASE_URL}/api/projects/${project.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: project.name,
                        description: project.description,
                        status: project.status,
                        starred: newVal,
                        meetingMinutes: project.meetingMinutes || project.meeting_minutes || '',
                        channels: project.channels || [],
                        applications: project.applications || []
                    })
                });
                
                if (response.ok) {
                    const updated = await response.json();
                    console.log('✓ Project starred status updated');
                    
                    // Update local project with server response
                    const idx = projects.findIndex(p => p.id === project.id);
                    if (idx >= 0) {
                        // Preserve local data structure while updating from server
                        projects[idx].starred = updated.starred;
                    }
                    renderProjects();
                } else {
                    throw new Error('Failed to update project');
                }
            } catch (err) {
                console.error('Failed to persist star:', err);
                // Revert optimistic update
                project.starred = oldVal;
                renderProjects();
                alert('Failed to update star status. Please try again.');
            }
        }

        // Channel Management Functions
        async function toggleProjectChannel(projectIndex, channel) {
            const project = projects[projectIndex];
            
            // Initialize channels array if it doesn't exist
            if (!project.channels) {
                project.channels = [];
            }
            
            // Check if channel already exists
            if (project.channels.includes(channel)) {
                return; // Already has this channel
            }
            
            // Add channel
            project.channels.push(channel);
            
            // Optimistic UI update
            renderProjects();
            
            // Persist to server if project has ID
            if (project.id) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/projects/${project.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: project.name,
                            description: project.description,
                            status: project.status,
                            starred: project.starred,
                            meetingMinutes: project.meetingMinutes || project.meeting_minutes || '',
                            channels: project.channels,
                            applications: project.applications || []
                        })
                    });
                    
                    if (response.ok) {
                        console.log(`✓ Channel "${channel}" added to project`);
                    } else {
                        throw new Error('Failed to update project');
                    }
                } catch (err) {
                    console.error('Failed to add channel:', err);
                    // Revert on error
                    project.channels = project.channels.filter(c => c !== channel);
                    renderProjects();
                    alert('Failed to add channel. Please try again.');
                }
            } else {
                // No ID, just persist locally
                await persistData();
            }
        }

        async function removeChannelFromProject(projectIndex, channel) {
            const project = projects[projectIndex];
            
            if (!project.channels) {
                return;
            }
            
            // Remove channel
            const oldChannels = [...project.channels];
            project.channels = project.channels.filter(c => c !== channel);
            
            // Optimistic UI update
            renderProjects();
            
            // Persist to server if project has ID
            if (project.id) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/projects/${project.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: project.name,
                            description: project.description,
                            status: project.status,
                            starred: project.starred,
                            meetingMinutes: project.meetingMinutes || project.meeting_minutes || '',
                            channels: project.channels,
                            applications: project.applications || []
                        })
                    });
                    
                    if (response.ok) {
                        console.log(`✓ Channel "${channel}" removed from project`);
                    } else {
                        throw new Error('Failed to update project');
                    }
                } catch (err) {
                    console.error('Failed to remove channel:', err);
                    // Revert on error
                    project.channels = oldChannels;
                    renderProjects();
                    alert('Failed to remove channel. Please try again.');
                }
            } else {
                // No ID, just persist locally
                await persistData();
            }
        }

        // Application Management Functions
        async function toggleProjectApplication(projectIndex, application) {
            const project = projects[projectIndex];
            
            // Initialize applications array if it doesn't exist
            if (!project.applications) {
                project.applications = [];
            }
            
            // Check if application already exists
            if (project.applications.includes(application)) {
                return; // Already has this application
            }
            
            // Add application
            project.applications.push(application);
            
            // Optimistic UI update
            renderProjects();
            
            // Persist to server if project has ID
            if (project.id) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/projects/${project.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: project.name,
                            description: project.description,
                            status: project.status,
                            starred: project.starred,
                            meetingMinutes: project.meetingMinutes || project.meeting_minutes || '',
                            channels: project.channels || [],
                            applications: project.applications
                        })
                    });
                    
                    if (response.ok) {
                        console.log(`✓ Application "${application}" added to project`);
                    } else {
                        throw new Error('Failed to update project');
                    }
                } catch (err) {
                    console.error('Failed to add application:', err);
                    // Revert on error
                    project.applications = project.applications.filter(a => a !== application);
                    renderProjects();
                    alert('Failed to add application. Please try again.');
                }
            } else {
                // No ID, just persist locally
                await persistData();
            }
        }

        async function removeApplicationFromProject(projectIndex, application) {
            const project = projects[projectIndex];
            
            if (!project.applications) {
                return;
            }
            
            // Remove application
            const oldApplications = [...project.applications];
            project.applications = project.applications.filter(a => a !== application);
            
            // Optimistic UI update
            renderProjects();
            
            // Persist to server if project has ID
            if (project.id) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/projects/${project.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: project.name,
                            description: project.description,
                            status: project.status,
                            starred: project.starred,
                            meetingMinutes: project.meetingMinutes || project.meeting_minutes || '',
                            channels: project.channels || [],
                            applications: project.applications
                        })
                    });
                    
                    if (response.ok) {
                        console.log(`✓ Application "${application}" removed from project`);
                    } else {
                        throw new Error('Failed to update project');
                    }
                } catch (err) {
                    console.error('Failed to remove application:', err);
                    // Revert on error
                    project.applications = oldApplications;
                    renderProjects();
                    alert('Failed to remove application. Please try again.');
                }
            } else {
                // No ID, just persist locally
                await persistData();
            }
        }

        // Load server data (projects + teamMembers) if available
        function loadServerData() {
            fetch('/api/data').then(r => r.json()).then(data => {
                if (data.teamMembers) teamMembers = data.teamMembers;
                if (data.projects) projects = data.projects;
                renderProjects();
            }).catch(err => {
                console.log('Server data not available, using sample data');
                renderProjects();
            });
        }

        // attempt to load server data immediately
        loadServerData();

        // Render projects
        function renderProjects() {
            const grid = document.getElementById('projectsGrid');
            
            // Update team member filter dropdown
            const memberFilter = document.getElementById('projectMemberFilter');
            if (memberFilter) {
                const currentMemberFilter = memberFilter.value;
                memberFilter.innerHTML = '<option value="">All Team Members</option>';
                teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name;
                    if (currentMemberFilter === member.name) {
                        option.selected = true;
                    }
                    memberFilter.appendChild(option);
                });
            }
            
            // Get filter values
            const searchQuery = document.getElementById('projectSearchInput') ? document.getElementById('projectSearchInput').value.toLowerCase() : '';
            const selectedStatus = document.getElementById('projectStatusFilter') ? document.getElementById('projectStatusFilter').value : '';
            const selectedMember = document.getElementById('projectMemberFilter') ? document.getElementById('projectMemberFilter').value : '';
            
            // Filter projects
            let filteredProjects = projects;
            if (searchQuery) {
                filteredProjects = filteredProjects.filter(p => p.name.toLowerCase().includes(searchQuery));
            }
            if (selectedStatus) {
                filteredProjects = filteredProjects.filter(p => p.status === selectedStatus);
            }
            if (selectedMember) {
                filteredProjects = filteredProjects.filter(p => p.team.includes(selectedMember));
            }

            // Sort starred/urgent projects to the top
            filteredProjects.sort((a, b) => (b.starred ? 1 : 0) - (a.starred ? 1 : 0));
            
            grid.innerHTML = filteredProjects.map((project, filteredIndex) => {
                const pIndex = projects.indexOf(project);
                return `
                <div class="project-card" data-project="${project.name}" data-index="${pIndex}">
                    <button class="edit-project-btn" onclick="editProject(${pIndex})" title="Edit project">✎</button>
                    <button class="delete-project-btn" onclick="deleteProject(${pIndex})" title="Delete project">×</button>
                    
                    <div class="project-header">
                        <div class="project-title">${project.name}</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="position: relative;">
                                <div class="project-status status-${project.status}" onclick="toggleStatusDropdown(${pIndex})" title="Click to change status">
                                    ${project.status.charAt(0).toUpperCase() + project.status.slice(1).replace('-', ' ')}
                                </div>
                                <div id="statusDropdown${pIndex}" class="status-dropdown" style="display: none;">
                                    <div class="status-option" onclick="updateProjectStatus(${pIndex}, 'planning')">📋 Planning</div>
                                    <div class="status-option" onclick="updateProjectStatus(${pIndex}, 'active')">🚀 Active</div>
                                    <div class="status-option" onclick="updateProjectStatus(${pIndex}, 'on-hold')">⏸️ On Hold</div>
                                    <div class="status-option" onclick="updateProjectStatus(${pIndex}, 'completed')">✅ Completed</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-size: 12px; color: #666; white-space: nowrap;">📅 Delivery:</label>
                                <input type="date" 
                                       value="${project.deliveryDate || ''}" 
                                       onchange="updateProjectDeliveryDate(${pIndex}, this.value)"
                                       style="padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; cursor: pointer;"
                                       title="Set delivery date">
                            </div>
                        </div>
                    </div>

                    <div class="project-image-container">
                        ${project.images && project.images.length > 0 ? `
                            <div class="project-images-grid">
                                ${project.images.map((img, imgIndex) => {
                                    // Handle both object {id, image_data} and string formats
                                    const imageData = typeof img === 'string' ? img : img.image_data;
                                    const imageId = typeof img === 'object' ? img.id : imgIndex;
                                    return `
                                    <div class="project-image-item" onclick="viewImage('${imageData.replace(/'/g, "\\'")}')">
                                        <img src="${imageData}" class="project-image" alt="${project.name}">
                                        <button class="remove-single-image-btn" onclick="removeProjectImageByIndex(event, ${pIndex}, ${imgIndex}, ${imageId})" title="Remove image">×</button>
                                    </div>
                                `}).join('')}
                                <div class="project-add-image-btn" onclick="triggerImageUpload(${pIndex})">
                                    + Add Image
                                </div>
                            </div>
                        ` : `
                            <div class="project-image-placeholder" onclick="triggerImageUpload(${pIndex})" style="cursor: pointer;">
                                📸 Click to add project images
                            </div>
                        `}
                    </div>
                    <input type="file" id="projectImageUpload${pIndex}" accept="image/*" multiple style="display: none;" onchange="handleProjectImageUpload(event, ${pIndex})">
                    
                    <div style="text-align: center; margin: 10px 0;">
                        <button class="star-btn ${project.starred ? 'starred' : ''}" onclick="toggleStar(${pIndex})" title="${project.starred ? 'Unmark urgent' : 'Mark urgent'}" style="position: static; margin: 0 auto;">${project.starred ? '★' : '☆'}</button>
                    </div>
                    
                    <div style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        ${project.description}
                    </div>
                    
                    <!-- Channel Selection -->
                    <div class="channel-container">
                        <span class="channel-label">📢 Channels:</span>
                        ${project.channels && project.channels.length > 0 ? 
                            project.channels.map(channel => `
                                <div class="channel-badge ${channel.toLowerCase().replace(/\s+/g, '-')} selected">
                                    ${channel}
                                    <span class="remove-channel" onclick="removeChannelFromProject(${pIndex}, '${channel}')">×</span>
                                </div>
                            `).join('') 
                            : '<span style="color: #999; font-size: 12px;">No channels assigned</span>'
                        }
                        <div class="channel-badge agent ${project.channels && project.channels.includes('Agent') ? '' : ''}" 
                             onclick="toggleProjectChannel(${pIndex}, 'Agent')"
                             style="${project.channels && project.channels.includes('Agent') ? 'display: none;' : ''}"
                             title="Add Agent channel">
                            + Agent
                        </div>
                        <div class="channel-badge partnership ${project.channels && project.channels.includes('Partnership') ? '' : ''}" 
                             onclick="toggleProjectChannel(${pIndex}, 'Partnership')"
                             style="${project.channels && project.channels.includes('Partnership') ? 'display: none;' : ''}"
                             title="Add Partnership channel">
                            + Partnership
                        </div>
                        <div class="channel-badge direct-marketing ${project.channels && project.channels.includes('Direct marketing') ? '' : ''}" 
                             onclick="toggleProjectChannel(${pIndex}, 'Direct marketing')"
                             style="${project.channels && project.channels.includes('Direct marketing') ? 'display: none;' : ''}"
                             title="Add Direct marketing channel">
                            + Direct marketing
                        </div>
                    </div>
                    
                    <!-- Application Selection -->
                    <div class="application-container">
                        <span class="application-label">💻 Applications:</span>
                        ${project.applications && project.applications.length > 0 ? 
                            project.applications.map(app => {
                                const appClass = app.toLowerCase().replace(/\s+/g, '-');
                                return `
                                <div class="application-badge app-${appClass} selected">
                                    ${app}
                                    <span class="remove-app" onclick="removeApplicationFromProject(${pIndex}, '${app.replace(/'/g, "\\'")}')">×</span>
                                </div>
                            `}).join('') 
                            : '<span style="color: #999; font-size: 11px;">No applications assigned</span>'
                        }
                        ${['TL PRO PLUS', 'TL TEAM PLUS', 'TL AFTER PLUS', 'New DA', 'E-Selling', 'E-Portal', 'NSP', 'TL SMART', 'Common', 'DFL'].map(app => {
                            const appClass = app.toLowerCase().replace(/\s+/g, '-');
                            const hasApp = project.applications && project.applications.includes(app);
                            return `
                            <div class="application-badge app-${appClass}" 
                                 onclick="toggleProjectApplication(${pIndex}, '${app.replace(/'/g, "\\'")}')"
                                 style="${hasApp ? 'display: none;' : ''}"
                                 title="Add ${app}">
                                + ${app}
                            </div>
                        `}).join('')}
                    </div>
                    
                    <div class="project-team">
                        <div class="project-team-label">Team Members (${project.team.length})</div>
                        <div class="team-members">
                            ${project.team.map(member => `
                                <div class="member-tag">
                                    ${member}
                                    <span class="remove-btn" onclick="removeMemberFromProject('${project.name}', '${member}')">×</span>
                                </div>
                            `).join('')}
                            ${project.team.length === 0 ? '<div style="color: #999; font-size: 13px;">Drop team member here or click assign</div>' : ''}
                        </div>
                        <button class="assign-member-btn" onclick="openAssignModal('${project.name}')">+ Assign Member</button>
                    </div>
                    <div class="project-meeting-minutes">
                        <div class="meeting-minutes-label" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>📋 Meeting Minutes</span>
                            <button class="edit-meeting-btn" onclick="toggleMeetingMinutesEdit(${pIndex})" title="Edit meeting minutes" style="background: #667eea; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">✎ Edit</button>
                        </div>
                        <div id="meetingMinutes${pIndex}" class="meeting-minutes-content" onclick="toggleMeetingMinutesEdit(${pIndex})" style="cursor: pointer;">
                            ${project.meetingMinutes ? `<div style="white-space: pre-wrap; word-break: break-word;">${project.meetingMinutes}</div>` : `<div class="meeting-minutes-empty">No meeting minutes added yet</div>`}
                        </div>
                        <div id="meetingMinutesEdit${pIndex}" class="meeting-minutes-edit" style="display: none;">
                            <textarea id="meetingMinutesTextarea${pIndex}" class="meeting-minutes-textarea" style="width: 100%; height: 150px; padding: 10px; border: 2px solid #667eea; border-radius: 6px; font-size: 13px; resize: vertical; font-family: inherit;">${project.meetingMinutes || ''}</textarea>
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="task-add-confirm" onclick="saveMeetingMinutes(${pIndex})" style="flex: 1;">Save</button>
                                <button style="flex: 1; background: #e0e0e0; color: #666; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer;" onclick="toggleMeetingMinutesEdit(${pIndex})">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="project-links">
                        <div class="project-links-label">Links (${(project.links || []).length})</div>
                        <div class="links-list">
                            ${(project.links || []).length > 0 ? (project.links || []).map((link, lIndex) => `
                                <div class="link-item">
                                    <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="link-text" title="${link.title || link.url}">
                                        🔗 ${link.title || link.url}
                                    </a>
                                    <button class="remove-link-btn" onclick="removeProjectLink(${pIndex}, ${lIndex})" title="Remove link">×</button>
                                </div>
                            `).join('') : '<div style="color: #999; font-size: 13px;">No links yet</div>'}
                        </div>
                        <div class="add-link-input-container" id="linkInput${pIndex}" style="display: none;">
                            <input type="text" class="link-title-input" id="linkTitle${pIndex}" placeholder="Link title (optional)" style="margin-bottom: 8px;">
                            <input type="url" class="link-url-input" id="linkUrl${pIndex}" placeholder="https://example.com">
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button class="task-add-confirm" onclick="addProjectLink(${pIndex})" style="flex: 1;">Add Link</button>
                                <button style="flex: 1; background: #e0e0e0; color: #666; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer;" onclick="toggleLinkInput(${pIndex})">Cancel</button>
                            </div>
                        </div>
                        <button class="assign-member-btn" onclick="toggleLinkInput(${pIndex})">+ Add Link</button>
                    </div>
                    <div class="tasks-section">
                        <div class="tasks-header">
                            <span class="tasks-label">Tasks (${project.tasks.filter(t => t.completed).length}/${project.tasks.length})</span>
                            <button class="add-task-btn" onclick="showTaskInput(${pIndex})">+ Add Task</button>
                        </div>
                        <div id="taskInput${pIndex}" class="task-input-container" style="display: none;">
                            <input type="text" class="task-input" id="taskText${pIndex}" placeholder="Enter task description..." onkeypress="if(event.key === 'Enter') addTask(${pIndex})">
                            <button class="task-add-confirm" onclick="addTask(${pIndex})">Add</button>
                        </div>
                        <div class="task-list">
                            ${project.tasks.length > 0 ? (() => {
                                // Sort tasks: incomplete first, completed at bottom
                                const sortedTasks = [...project.tasks].sort((a, b) => {
                                    // Sort by completion status (incomplete = false comes first)
                                    if (!a.completed && b.completed) return -1;
                                    if (a.completed && !b.completed) return 1;
                                    
                                    // If both have same completion status, maintain relative order
                                    return 0;
                                });
                                
                                return sortedTasks.map((task) => {
                                // Get the original index from the unsorted array
                                const tIndex = project.tasks.indexOf(task);
                                const isOverdue = task.endDate && new Date(task.endDate) < new Date() && !task.completed;
                                const formattedStart = task.startDate ? new Date(task.startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : null;
                                const formattedEnd = task.endDate ? new Date(task.endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : null;
                                const subtasks = task.subtasks || [];
                                const completedSubtasks = subtasks.filter(s => s.completed).length;
                                
                                return `
                                <div class="task-item">
                                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${pIndex}, ${tIndex})">
                                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                        <span class="task-text ${task.completed ? 'completed' : ''}">${task.text}</span>
                                        <div class="task-dates">
                                            ${formattedStart && formattedEnd 
                                                ? `<span class="task-date ${isOverdue ? 'overdue' : ''}" onclick="showDatePicker(event, ${pIndex}, ${tIndex})" style="cursor: pointer;" title="Click to edit dates">📅 ${formattedStart} → ${formattedEnd}</span>`
                                                : `<span class="task-date-input" onclick="showDatePicker(event, ${pIndex}, ${tIndex})">+ Add dates</span>`
                                            }
                                        </div>
                                        ${subtasks.length > 0 ? `
                                            <div class="subtasks-container">
                                                ${subtasks.map((subtask, sIndex) => `
                                                    <div class="subtask-item">
                                                        <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} onchange="toggleSubtask(${pIndex}, ${tIndex}, ${sIndex})">
                                                        <span class="subtask-text ${subtask.completed ? 'completed' : ''}">${subtask.text}</span>
                                                        ${subtask.assignee 
                                                            ? `<span class="subtask-assignee" onclick="showSubtaskAssigneeDropdown(event, ${pIndex}, ${tIndex}, ${sIndex})" title="Click to reassign">${subtask.assignee.split(' ')[0]}</span>`
                                                            : `<span class="subtask-assignee-btn" onclick="showSubtaskAssigneeDropdown(event, ${pIndex}, ${tIndex}, ${sIndex})" title="Assign to team member">Assign</span>`
                                                        }
                                                        <span class="subtask-edit" onclick="editSubtask(${pIndex}, ${tIndex}, ${sIndex})" title="Edit subtask">✎</span>
                                                        <span class="subtask-delete" onclick="deleteSubtask(${pIndex}, ${tIndex}, ${sIndex})" title="Delete subtask">×</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div class="subtasks-progress">${completedSubtasks}/${subtasks.length} subtasks done</div>
                                        ` : ''}
                                        <div id="subtaskInput${pIndex}-${tIndex}" style="display: none;">
                                            <div class="subtask-input-container">
                                                <input type="text" class="subtask-input" id="subtaskText${pIndex}-${tIndex}" placeholder="Add a subtask..." onkeypress="if(event.key === 'Enter') addSubtask(${pIndex}, ${tIndex})">
                                                <button class="subtask-confirm" onclick="addSubtask(${pIndex}, ${tIndex})">Add</button>
                                                <button style="background: #e0e0e0; color: #666; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;" onclick="toggleSubtaskInput(${pIndex}, ${tIndex})">Cancel</button>
                                            </div>
                                        </div>
                                        ${subtasks.length === 0 ? `<button class="add-subtask-btn" onclick="toggleSubtaskInput(${pIndex}, ${tIndex})">+ Add Subtask</button>` : `<button class="add-subtask-btn" onclick="toggleSubtaskInput(${pIndex}, ${tIndex})">+ Add another</button>`}
                                    </div>
                                    ${task.assignee 
                                        ? `<span class="task-assignee" onclick="showAssigneeDropdown(event, ${pIndex}, ${tIndex})">${task.assignee.split(' ')[0]}</span>`
                                        : `<span class="task-assignee-btn" onclick="showAssigneeDropdown(event, ${pIndex}, ${tIndex})">Assign</span>`
                                    }
                                    <span class="task-edit" onclick="editTask(${pIndex}, ${tIndex})" title="Edit task">✎</span>
                                    <span class="task-delete" onclick="deleteTask(${pIndex}, ${tIndex})">×</span>
                                </div>
                            `}).join('');
                            })() : '<div class="no-tasks">No tasks yet</div>'}
                        </div>
                    </div>
                </div>
            `}).join('');
            
            // Show "no results" message if no projects match the filter
            if (filteredProjects.length === 0) {
                grid.innerHTML = '<div class="no-tasks-message">No projects match the selected filters.</div>';
            }

            // Add drop event listeners
            document.querySelectorAll('.project-card').forEach(card => {
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragleave', handleDragLeave);
            });
        }

        // Render task overview dashboard
        function renderTaskOverview() {
            const container = document.getElementById('taskOverview');
            
            // Update member filter dropdown
            const memberFilter = document.getElementById('memberFilter');
            const currentMemberFilter = memberFilter.value;
            memberFilter.innerHTML = '<option value="">All Team Members</option>';
            memberFilter.innerHTML += '<option value="unassigned">🔴 Unassigned Tasks</option>';
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                if (currentMemberFilter === member.name) {
                    option.selected = true;
                }
                memberFilter.appendChild(option);
            });
            if (currentMemberFilter === 'unassigned') {
                memberFilter.value = 'unassigned';
            }
            
            // Update project filter dropdown
            const projectFilter = document.getElementById('projectFilter');
            const currentProjectFilter = projectFilter.value;
            projectFilter.innerHTML = '<option value="">All Projects</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.name;
                option.textContent = project.name;
                if (currentProjectFilter === project.name) {
                    option.selected = true;
                }
                projectFilter.appendChild(option);
            });
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<div class="no-tasks-message">No team members yet. Add team members to see their task overview.</div>';
                return;
            }
            
            // Get filter values
            const selectedMember = document.getElementById('memberFilter').value;
            const selectedStatus = document.getElementById('statusFilter').value;
            const selectedProject = document.getElementById('projectFilter').value;
            
            let html = '';
            let hasResults = false;
            
            // Handle UNASSIGNED TASKS filter
            if (selectedMember === 'unassigned') {
                // Show unassigned tasks grouped by project
                html = '<div style="margin-bottom: 20px;"><h3 style="color: #333; font-size: 22px;">🔴 Unassigned Tasks by Project</h3></div>';
                let hasUnassignedTasks = false;
                
                projects.forEach((project, projectIndex) => {
                    if (selectedProject && project.name !== selectedProject) return;
                    
                    const unassignedTasks = project.tasks.filter(t => !t.assignee);
                    
                    if (unassignedTasks.length > 0) {
                        hasUnassignedTasks = true;
                        html += `
                            <div class="member-overview-card">
                                <div class="member-overview-header">
                                    <div class="member-overview-info">
                                        <div>
                                            <h3 style="font-size: 20px; color: #333;">📁 ${project.name}</h3>
                                            <div style="color: #666; font-size: 14px;">Status: ${project.status.charAt(0).toUpperCase() + project.status.slice(1).replace('-', ' ')}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 12px; color: #666;">Unassigned Tasks</div>
                                        <div style="font-size: 24px; font-weight: 700; color: #dc3545;">${unassignedTasks.length}</div>
                                    </div>
                                </div>
                                <div class="task-detail-section">
                                    <div class="task-detail-header">🔴 Tasks Without Assignee (${unassignedTasks.length})</div>
                                    <div class="task-detail-list">
                        `;
                        
                        unassignedTasks.forEach(task => {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const isOverdue = task.endDate && new Date(task.endDate) < today && !task.completed;
                            
                            html += `
                                <div class="task-detail-item ${task.completed ? 'done' : (isOverdue ? 'delayed' : 'onplan')}"
                                     onclick="goToProjectFromTaskMonitor(${projectIndex})"
                                     style="cursor: pointer;"
                                     title="Click to view in Projects tab">
                                    <div class="task-detail-title ${task.completed ? 'completed' : ''}">${task.text}</div>
                                    <div class="task-detail-meta">
                                        ${task.startDate && task.endDate ? `<span>📅 ${new Date(task.startDate).toLocaleDateString()} → ${new Date(task.endDate).toLocaleDateString()}</span>` : '<span>📅 No dates set</span>'}
                                        ${task.completed ? '<span>✅ Completed</span>' : (isOverdue ? '<span style="color: #dc3545;">⚠️ Overdue</span>' : '')}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                if (!hasUnassignedTasks) {
                    html += '<div class="no-tasks-message">✅ All tasks are assigned! No unassigned tasks found.</div>';
                }
                
                container.innerHTML = html;
                return;
            }
            
            // Filter members (normal flow)
            let filteredMembers = teamMembers;
            if (selectedMember && selectedMember !== 'unassigned') {
                filteredMembers = teamMembers.filter(m => m.name === selectedMember);
            }
            
            filteredMembers.forEach(member => {
                // Get all tasks assigned to this member across all projects
                let memberTasks = [];
                projects.forEach((project, projectIndex) => {
                    if (project.tasks) {
                        project.tasks.forEach(task => {
                            if (task.assignee === member.name) {
                                memberTasks.push({
                                    ...task,
                                    projectName: project.name,
                                    projectStatus: project.status,
                                    projectIndex: projectIndex
                                });
                            }
                        });
                    }
                });

                // Get all subtasks assigned to this member across all projects/tasks
                let memberSubtasks = [];
                projects.forEach(project => {
                    if (project.tasks) {
                        project.tasks.forEach(task => {
                            const subtasks = task.subtasks || [];
                            subtasks.forEach(subtask => {
                                if (subtask.assignee === member.name) {
                                    memberSubtasks.push({
                                        ...subtask,
                                        parentTaskText: task.text,
                                        parentStartDate: task.startDate || null,
                                        parentEndDate: task.endDate || null,
                                        projectName: project.name
                                    });
                                }
                            });
                        });
                    }
                });
                
                // Apply project filter
                if (selectedProject) {
                    memberTasks = memberTasks.filter(t => t.projectName === selectedProject);
                }
                
                // Calculate statistics
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const doneTasks = memberTasks.filter(t => t.completed);
                const onPlanTasks = memberTasks.filter(t => {
                    if (t.completed) return false;
                    if (!t.endDate) return true; // No deadline = on plan
                    const endDate = new Date(t.endDate);
                    endDate.setHours(0, 0, 0, 0);
                    return endDate >= today;
                });
                const delayedTasks = memberTasks.filter(t => {
                    if (t.completed) return false;
                    if (!t.endDate) return false;
                    const endDate = new Date(t.endDate);
                    endDate.setHours(0, 0, 0, 0);
                    return endDate < today;
                });
                
                // Tasks with no start date
                const noDateTasks = memberTasks.filter(t => !t.startDate);
                
                // Apply status filter
                let tasksToShow = {
                    delayed: delayedTasks,
                    onplan: onPlanTasks,
                    done: doneTasks,
                    nodate: noDateTasks
                };
                
                if (selectedStatus) {
                    // Only show the selected status
                    const filteredTasksToShow = {};
                    filteredTasksToShow[selectedStatus] = tasksToShow[selectedStatus];
                    tasksToShow = filteredTasksToShow;
                }
                
                // Check if this member has any tasks to show
                const hasTasks = Object.values(tasksToShow).some(arr => arr.length > 0);
                if (!hasTasks && selectedStatus) {
                    return; // Skip this member if no tasks match the filter
                }
                
                hasResults = true;
                
                html += `
                    <div class="member-overview-card">
                        <div class="member-overview-header">
                            <div class="member-overview-info">
                                <div class="avatar">${member.name.split(' ').map(n => n[0]).join('')}</div>
                                <div>
                                    <h3 style="font-size: 20px; color: #333;">${member.name}</h3>
                                    <div style="color: #666; font-size: 14px;">${member.role}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #666;">Total Tasks</div>
                                <div style="font-size: 24px; font-weight: 700; color: #667eea;">${memberTasks.length}</div>
                            </div>
                        </div>
                        
                        <div class="member-overview-stats">
                            <div class="stat-box done">
                                <div class="stat-number">${doneTasks.length}</div>
                                <div class="stat-label">✅ Done</div>
                            </div>
                            <div class="stat-box onplan">
                                <div class="stat-number">${onPlanTasks.length}</div>
                                <div class="stat-label">📅 On Plan</div>
                            </div>
                            <div class="stat-box delayed">
                                <div class="stat-number">${delayedTasks.length}</div>
                                <div class="stat-label">⚠️ Delayed</div>
                            </div>
                        </div>
                `;
                
                // Show task details based on filter
                if (memberTasks.length > 0) {
                    // Delayed tasks
                    if (tasksToShow.delayed && tasksToShow.delayed.length > 0) {
                        html += `
                            <div class="task-detail-section">
                                <div class="task-detail-header">⚠️ Delayed Tasks (${tasksToShow.delayed.length})</div>
                                <div class="task-detail-list">
                        `;
                        tasksToShow.delayed.forEach(task => {
                            const daysOverdue = Math.floor((today - new Date(task.endDate)) / (1000 * 60 * 60 * 24));
                            html += `
                                <div class="task-detail-item delayed" 
                                     onclick="goToProjectFromTaskMonitor(${task.projectIndex})"
                                     style="cursor: pointer;"
                                     title="Click to view in Projects tab">
                                    <div class="task-detail-title">${task.text}</div>
                                    <div class="task-detail-meta">
                                        <span>📁 ${task.projectName}</span>
                                        ${task.startDate && task.endDate ? `<span>📅 ${new Date(task.startDate).toLocaleDateString()} → ${new Date(task.endDate).toLocaleDateString()}</span>` : ''}
                                        <span style="color: #dc3545; font-weight: 600;">⏰ ${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} overdue</span>
                                    </div>
                                </div>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // On plan tasks
                    if (tasksToShow.onplan && tasksToShow.onplan.length > 0) {
                        html += `
                            <div class="task-detail-section">
                                <div class="task-detail-header">📅 On Plan Tasks (${tasksToShow.onplan.length})</div>
                                <div class="task-detail-list">
                        `;
                        tasksToShow.onplan.forEach(task => {
                            html += `
                                <div class="task-detail-item onplan"
                                     onclick="goToProjectFromTaskMonitor(${task.projectIndex})"
                                     style="cursor: pointer;"
                                     title="Click to view in Projects tab">
                                    <div class="task-detail-title">${task.text}</div>
                                    <div class="task-detail-meta">
                                        <span>📁 ${task.projectName}</span>
                                        ${task.startDate && task.endDate ? `<span>📅 ${new Date(task.startDate).toLocaleDateString()} → ${new Date(task.endDate).toLocaleDateString()}</span>` : '<span>📅 No deadline set</span>'}
                                    </div>
                                </div>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // Done tasks
                    if (tasksToShow.done && tasksToShow.done.length > 0) {
                        html += `
                            <div class="task-detail-section">
                                <div class="task-detail-header">✅ Completed Tasks (${tasksToShow.done.length})</div>
                                <div class="task-detail-list">
                        `;
                        tasksToShow.done.forEach(task => {
                            html += `
                                <div class="task-detail-item done"
                                     onclick="goToProjectFromTaskMonitor(${task.projectIndex})"
                                     style="cursor: pointer;"
                                     title="Click to view in Projects tab">
                                    <div class="task-detail-title completed">${task.text}</div>
                                    <div class="task-detail-meta">
                                        <span>📁 ${task.projectName}</span>
                                        ${task.startDate && task.endDate ? `<span>📅 ${new Date(task.startDate).toLocaleDateString()} → ${new Date(task.endDate).toLocaleDateString()}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // No Start Date tasks
                    if (tasksToShow.nodate && tasksToShow.nodate.length > 0) {
                        html += `
                            <div class="task-detail-section">
                                <div class="task-detail-header">📭 Tasks Without Start Date (${tasksToShow.nodate.length})</div>
                                <div class="task-detail-list">
                        `;
                        tasksToShow.nodate.forEach(task => {
                            html += `
                                <div class="task-detail-item onplan"
                                     onclick="goToProjectFromTaskMonitor(${task.projectIndex})"
                                     style="cursor: pointer; border-left-color: #999;"
                                     title="Click to view in Projects tab">
                                    <div class="task-detail-title">${task.text}</div>
                                    <div class="task-detail-meta">
                                        <span>📁 ${task.projectName}</span>
                                        <span style="color: #999;">📭 No start date set</span>
                                        ${task.completed ? '<span>✅ Completed</span>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    if (!selectedStatus && memberTasks.length === 0) {
                        html += '<div class="no-tasks-message">No tasks assigned yet</div>';
                    }
                } else {
                    html += '<div class="no-tasks-message">No tasks assigned yet</div>';
                }
                // Show subtasks assigned to this member
                if (memberSubtasks.length > 0) {
                    // classify subtasks
                    const todaySub = new Date();
                    todaySub.setHours(0,0,0,0);
                    const doneSubs = memberSubtasks.filter(s => s.completed);
                    const onPlanSubs = memberSubtasks.filter(s => {
                        if (s.completed) return false;
                        if (!s.parentEndDate) return true;
                        const endDate = new Date(s.parentEndDate);
                        endDate.setHours(0,0,0,0);
                        return endDate >= todaySub;
                    });
                    const delayedSubs = memberSubtasks.filter(s => {
                        if (s.completed) return false;
                        if (!s.parentEndDate) return false;
                        const endDate = new Date(s.parentEndDate);
                        endDate.setHours(0,0,0,0);
                        return endDate < todaySub;
                    });

                    html += `
                        <div class="task-detail-section">
                            <div class="task-detail-header">🔸 Subtasks Assigned (${memberSubtasks.length})</div>
                            <div class="task-detail-list">
                    `;

                    // delayed subtasks
                    if (delayedSubs.length > 0) {
                        delayedSubs.forEach(s => {
                            const daysOverdue = s.parentEndDate ? Math.floor((new Date() - new Date(s.parentEndDate)) / (1000 * 60 * 60 * 24)) : 0;
                            html += `
                                <div class="task-detail-item delayed">
                                    <div class="task-detail-title">${s.text} <span style="font-weight:600;color:#dc3545;">(in: ${s.parentTaskText})</span></div>
                                    <div class="task-detail-meta">
                                        <span>📁 ${s.projectName}</span>
                                        ${s.parentStartDate && s.parentEndDate ? `<span>📅 ${new Date(s.parentStartDate).toLocaleDateString()} → ${new Date(s.parentEndDate).toLocaleDateString()}</span>` : ''}
                                        <span style="color: #dc3545; font-weight: 600;">⏰ ${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} overdue</span>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // onplan subtasks
                    if (onPlanSubs.length > 0) {
                        onPlanSubs.forEach(s => {
                            html += `
                                <div class="task-detail-item onplan">
                                    <div class="task-detail-title">${s.text} <span style="font-weight:600;color:#666;">(in: ${s.parentTaskText})</span></div>
                                    <div class="task-detail-meta">
                                        <span>📁 ${s.projectName}</span>
                                        ${s.parentStartDate && s.parentEndDate ? `<span>📅 ${new Date(s.parentStartDate).toLocaleDateString()} → ${new Date(s.parentEndDate).toLocaleDateString()}</span>` : '<span>📅 No deadline set</span>'}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // done subtasks
                    if (doneSubs.length > 0) {
                        doneSubs.forEach(s => {
                            html += `
                                <div class="task-detail-item done">
                                    <div class="task-detail-title completed">${s.text} <span style="font-weight:600;color:#666;">(in: ${s.parentTaskText})</span></div>
                                    <div class="task-detail-meta">
                                        <span>📁 ${s.projectName}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            
            if (!hasResults) {
                container.innerHTML = '<div class="no-tasks-message">No tasks match the selected filters.</div>';
            } else {
                container.innerHTML = html;
            }
        }

        function clearFilters() {
            document.getElementById('memberFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('projectFilter').value = '';
            renderTaskOverview();
        }

        // Navigate from Task Monitor to project in Projects tab
        function goToProjectFromTaskMonitor(projectIndex) {
            // Switch to Projects tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate projects tab
            const projectsTab = Array.from(document.querySelectorAll('.tab')).find(tab => 
                tab.getAttribute('onclick') && tab.getAttribute('onclick').includes("'projects'")
            );
            if (projectsTab) projectsTab.classList.add('active');
            document.getElementById('projects').classList.add('active');
            
            // Clear filters to ensure project is visible
            const searchInput = document.getElementById('projectSearchInput');
            const statusFilter = document.getElementById('projectStatusFilter');
            const memberFilter = document.getElementById('projectMemberFilter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (memberFilter) memberFilter.value = '';
            
            // Render projects
            renderProjects();
            
            // Wait for render, then scroll to and highlight the specific project
            setTimeout(() => {
                const projectCard = document.querySelector(`.project-card[data-index="${projectIndex}"]`);
                if (projectCard) {
                    // Scroll to project
                    projectCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    
                    // Apply highlight effect
                    const originalBoxShadow = projectCard.style.boxShadow;
                    const originalTransform = projectCard.style.transform;
                    const originalTransition = projectCard.style.transition;
                    
                    projectCard.style.transition = 'all 0.3s ease';
                    projectCard.style.boxShadow = '0 0 0 4px #667eea, 0 8px 32px rgba(102, 126, 234, 0.4)';
                    projectCard.style.transform = 'scale(1.02)';
                    
                    // Remove highlight after 2 seconds
                    setTimeout(() => {
                        projectCard.style.transition = 'all 0.5s ease';
                        projectCard.style.boxShadow = originalBoxShadow;
                        projectCard.style.transform = originalTransform;
                        
                        // Restore original transition after animation
                        setTimeout(() => {
                            projectCard.style.transition = originalTransition;
                        }, 500);
                    }, 2000);
                } else {
                    console.error('Project card not found for index:', projectIndex);
                }
            }, 200);
        }

        function clearProjectFilters() {
            if (document.getElementById('projectSearchInput')) {
                document.getElementById('projectSearchInput').value = '';
            }
            if (document.getElementById('projectStatusFilter')) {
                document.getElementById('projectStatusFilter').value = '';
            }
            if (document.getElementById('projectMemberFilter')) {
                document.getElementById('projectMemberFilter').value = '';
            }
            renderProjects();
        }

        // Calendar functions
        function renderCalendarView() {
            const container = document.getElementById('calendarView');
            const monthYearEl = document.getElementById('calendarMonthYear');
            
            // Update month/year display
            const monthName = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            monthYearEl.textContent = monthName;
            
            // Update project filter dropdown
            const projectFilter = document.getElementById('calendarProjectFilter');
            const currentProjectFilter = projectFilter.value;
            projectFilter.innerHTML = '<option value="">All Projects</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.name;
                option.textContent = project.name;
                if (currentProjectFilter === project.name) {
                    option.selected = true;
                }
                projectFilter.appendChild(option);
            });
            
            // Update member filter dropdown
            const memberFilter = document.getElementById('calendarMemberFilter');
            const currentMemberFilter = memberFilter.value;
            memberFilter.innerHTML = '<option value="">All Team Members</option>';
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                if (currentMemberFilter === member.name) {
                    option.selected = true;
                }
                memberFilter.appendChild(option);
            });
            
            // Get filter values
            const selectedProject = document.getElementById('calendarProjectFilter').value;
            const selectedMember = document.getElementById('calendarMemberFilter').value;
            
            // Get all tasks for the current month
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Create a map of dates to tasks
            const tasksByDate = {};
            
            // Initialize all days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                tasksByDate[dateKey] = [];
            }
            
            // Collect tasks that fall within the month
            projects.forEach((project, projectIndex) => {
                // Filter by project if selected
                if (selectedProject && project.name !== selectedProject) {
                    return;
                }
                
                project.tasks.forEach((task, taskIndex) => {
                    if (!task.startDate || !task.endDate) return;
                    
                    // Filter by member if selected
                    if (selectedMember && task.assignee !== selectedMember) {
                        return;
                    }
                    
                    const startDate = new Date(task.startDate);
                    const endDate = new Date(task.endDate);
                    const currentDate = new Date(year, month, 1);
                    const monthEnd = new Date(year, month + 1, 0);
                    
                    // Check if task overlaps with current month
                    if (startDate <= monthEnd && endDate >= currentDate) {
                        // Add task to all days within the month range
                        let checkDate = new Date(Math.max(startDate, currentDate));
                        const lastDate = new Date(Math.min(endDate, monthEnd));
                        
                        while (checkDate <= lastDate) {
                            const dateKey = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;
                            tasksByDate[dateKey].push({
                                text: task.text,
                                projectName: project.name,
                                projectIndex: projectIndex,
                                taskIndex: taskIndex,
                                completed: task.completed,
                                assignee: task.assignee,
                                startDate: task.startDate,
                                endDate: task.endDate
                            });
                            checkDate.setDate(checkDate.getDate() + 1);
                        }
                    }
                });
            });
            
            // Get first day of month (0 = Sunday, 1 = Monday, etc.)
            const firstDay = new Date(year, month, 1).getDay();
            // Convert to Monday-based week (Monday = 0, Sunday = 6)
            const firstDayMonday = (firstDay === 0) ? 6 : firstDay - 1;
            
            // Calculate the start date (might be from previous month)
            const startDate = new Date(year, month, 1);
            startDate.setDate(startDate.getDate() - firstDayMonday);
            
            // Day names starting from Monday
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            // Render calendar with week header
            let html = '';
            
            // Add week headers
            html += '<div class="calendar-week-header">Mon</div>';
            html += '<div class="calendar-week-header">Tue</div>';
            html += '<div class="calendar-week-header">Wed</div>';
            html += '<div class="calendar-week-header">Thu</div>';
            html += '<div class="calendar-week-header">Fri</div>';
            html += '<div class="calendar-week-header">Sat</div>';
            html += '<div class="calendar-week-header">Sun</div>';
            
            // Generate calendar days
            let currentDate = new Date(startDate);
            const today = new Date();
            const monthEnd = new Date(year, month + 1, 0);
            
            // Continue until we've covered the entire month and completed the last week
            while (true) {
                const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                const dayTasks = tasksByDate[dateKey] || [];
                
                const isToday = currentDate.getDate() === today.getDate() &&
                               currentDate.getMonth() === today.getMonth() &&
                               currentDate.getFullYear() === today.getFullYear();
                
                const isOtherMonth = currentDate.getMonth() !== month;
                const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                
                html += `
                    <div class="calendar-day-card ${isToday ? 'today' : ''} ${isOtherMonth ? 'other-month' : ''}">
                        <div class="calendar-day-header ${isToday ? 'today' : ''} ${isWeekend && !isToday ? 'weekend' : ''}">
                            ${currentDate.toLocaleDateString('default', { day: 'numeric' })}
                            ${isToday ? '⭐' : ''}
                        </div>
                        <div class="calendar-day-tasks">
                            ${dayTasks.length > 0 ? 
                                dayTasks.map(task => {
                                    const endTaskDate = new Date(task.endDate);
                                    const isOverdue = endTaskDate < new Date() && !task.completed;
                                    return `
                                        <div class="calendar-task-item ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" 
                                             onclick="goToProjectFromCalendar(${task.projectIndex})"
                                             title="Click to view in Projects tab"
                                             style="cursor: pointer;">
                                            <div class="calendar-task-text">${task.text}</div>
                                            <div class="calendar-task-meta">
                                                <span class="calendar-task-project">📁 ${task.projectName}</span>
                                                ${task.assignee ? `<span class="calendar-task-assignee">👤 ${task.assignee.split(' ')[0]}</span>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')
                            : `<div class="calendar-no-tasks">-</div>`
                            }
                        </div>
                    </div>
                `;
                
                // Move to next day
                currentDate.setDate(currentDate.getDate() + 1);
                
                // Stop when we've passed the month end and completed the current week (Sunday)
                if (currentDate > monthEnd && currentDate.getDay() === 1) {
                    break;
                }
            }
            
            if (daysInMonth === 0) {
                html = '<div class="calendar-empty-message">No days in this month</div>';
            }
            
            container.innerHTML = html;
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendarView();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendarView();
        }

        function clearCalendarFilters() {
            document.getElementById('calendarProjectFilter').value = '';
            document.getElementById('calendarMemberFilter').value = '';
            renderCalendarView();
        }

        // Navigate from calendar task to its project in Projects tab
        function goToProjectFromCalendar(projectIndex) {
            // Switch to Projects tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate projects tab - find the button with "projects" in onclick
            const projectsTab = Array.from(document.querySelectorAll('.tab')).find(tab => 
                tab.getAttribute('onclick') && tab.getAttribute('onclick').includes("'projects'")
            );
            if (projectsTab) projectsTab.classList.add('active');
            document.getElementById('projects').classList.add('active');
            
            // Clear filters to ensure project is visible
            const searchInput = document.getElementById('projectSearchInput');
            const statusFilter = document.getElementById('projectStatusFilter');
            const memberFilter = document.getElementById('projectMemberFilter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (memberFilter) memberFilter.value = '';
            
            // Render projects
            renderProjects();
            
            // Wait for render, then scroll to and highlight the specific project
            setTimeout(() => {
                const projectCard = document.querySelector(`.project-card[data-index="${projectIndex}"]`);
                if (projectCard) {
                    // Scroll to project
                    projectCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    
                    // Apply highlight effect
                    const originalBoxShadow = projectCard.style.boxShadow;
                    const originalTransform = projectCard.style.transform;
                    const originalTransition = projectCard.style.transition;
                    
                    projectCard.style.transition = 'all 0.3s ease';
                    projectCard.style.boxShadow = '0 0 0 4px #667eea, 0 8px 32px rgba(102, 126, 234, 0.4)';
                    projectCard.style.transform = 'scale(1.02)';
                    
                    // Remove highlight after 2 seconds
                    setTimeout(() => {
                        projectCard.style.transition = 'all 0.5s ease';
                        projectCard.style.boxShadow = originalBoxShadow;
                        projectCard.style.transform = originalTransform;
                        
                        // Restore original transition after animation
                        setTimeout(() => {
                            projectCard.style.transition = originalTransition;
                        }, 500);
                    }, 2000);
                } else {
                    console.error('Project card not found for index:', projectIndex);
                }
            }, 200);
        }

        // Add team member
        let editingMemberIndex = null;

        function addTeamMember() {
            editingMemberIndex = null;
            document.getElementById('teamModalHeader').textContent = 'Add Team Member';
            document.getElementById('teamModalSaveBtn').textContent = 'Add Member';
            document.getElementById('memberName').value = '';
            document.getElementById('memberRole').value = 'Developer';
            document.getElementById('memberSkills').value = '';
            openModal('team');
        }

        function editTeamMember(index) {
            editingMemberIndex = index;
            const member = teamMembers[index];
            
            document.getElementById('teamModalHeader').textContent = 'Edit Team Member';
            document.getElementById('teamModalSaveBtn').textContent = 'Save Changes';
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberRole').value = member.role;
            document.getElementById('memberSkills').value = member.skills.join(', ');
            
            openModal('team');
        }

        function saveTeamMember() {
            const name = document.getElementById('memberName').value.trim();
            const role = document.getElementById('memberRole').value;
            const skills = document.getElementById('memberSkills').value.split(',').map(s => s.trim()).filter(s => s);
            
            if (!name || skills.length === 0) {
                alert('Please fill in name and at least one skill');
                return;
            }
            
            if (editingMemberIndex !== null) {
                // Editing existing member
                const oldName = teamMembers[editingMemberIndex].name;
                const member = teamMembers[editingMemberIndex];
                
                // Update member info
                member.name = name;
                member.role = role;
                member.skills = skills;
                
                // Update name in all projects if name changed
                if (oldName !== name) {
                    projects.forEach(project => {
                        // Update project team
                        const teamIndex = project.team.indexOf(oldName);
                        if (teamIndex !== -1) {
                            project.team[teamIndex] = name;
                        }
                        
                        // Update task assignees
                        if (project.tasks) {
                            project.tasks.forEach(task => {
                                if (task.assignee === oldName) {
                                    task.assignee = name;
                                }
                            });
                        }
                    });
                    
                    // Update member's project list
                    member.projects = member.projects || [];
                }
                
                renderProjects();
            } else {
                // Adding new member
                teamMembers.push({
                    name,
                    role,
                    skills,
                    workload: 0,
                    projects: []
                });
            }
            
            renderTeam();
            closeModal('team');
            editingMemberIndex = null;
            persistData();
        }

        // Remove team member
        function removeTeamMember(memberName) {
            if (confirm(`Are you sure you want to remove ${memberName} from the team?`)) {
                const member = teamMembers.find(m => m.name === memberName);
                
                // Remove from all projects first
                if (member && member.projects.length > 0) {
                    member.projects.forEach(projectName => {
                        const project = projects.find(p => p.name === projectName);
                        if (project) {
                            project.team = project.team.filter(m => m !== memberName);
                        }
                    });
                }
                
                // Remove from team
                teamMembers = teamMembers.filter(m => m.name !== memberName);
                
                renderTeam();
                renderProjects();
                persistData();
            }
        }

        // Add project
        let editingProjectIndex = null;

        function addProject() {
            editingProjectIndex = null;
            document.getElementById('projectModalHeader').textContent = 'Add Project';
            document.getElementById('projectModalSaveBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectStatus').value = 'planning';
            document.getElementById('projectDesc').value = '';
            document.getElementById('projectMeetingMinutes').value = '';
            document.getElementById('projectImage').value = '';
            openModal('project');
        }

        function editProject(index) {
            editingProjectIndex = index;
            const project = projects[index];
            
            document.getElementById('projectModalHeader').textContent = 'Edit Project';
            document.getElementById('projectModalSaveBtn').textContent = 'Save Changes';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectDesc').value = project.description;
            document.getElementById('projectMeetingMinutes').value = project.meetingMinutes || '';
            document.getElementById('projectImage').value = '';
            
            openModal('project');
        }

        function saveProject() {
            const name = document.getElementById('projectName').value.trim();
            const status = document.getElementById('projectStatus').value;
            const description = document.getElementById('projectDesc').value.trim();
            const meetingMinutes = document.getElementById('projectMeetingMinutes').value.trim();
            const imageFiles = document.getElementById('projectImage').files;
            
            if (!name || !description) {
                alert('Please fill in both Project Name and Description');
                return;
            }
            
            // Handle multiple images
            const processImages = async () => {
                const imageDataArray = [];
                
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    const imageData = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                    imageDataArray.push(imageData);
                }
                
                if (editingProjectIndex !== null) {
                    // Editing existing project
                    const oldName = projects[editingProjectIndex].name;
                    const project = projects[editingProjectIndex];
                    
                    // Update project info
                    project.name = name;
                    project.status = status;
                    project.description = description;
                    project.meetingMinutes = meetingMinutes;
                    
                    // Add new images to existing ones
                    if (imageDataArray.length > 0) {
                        if (!project.images) {
                            project.images = [];
                        }
                        project.images = [...project.images, ...imageDataArray];
                    }
                    
                    // Update name in all team members if name changed
                    if (oldName !== name) {
                        teamMembers.forEach(member => {
                            const projectIndex = member.projects.indexOf(oldName);
                            if (projectIndex !== -1) {
                                member.projects[projectIndex] = name;
                            }
                        });
                    }
                    
                    renderTeam();
                } else {
                    // Adding new project
                    projects.push({
                        name,
                        status,
                        description,
                        meetingMinutes,
                        team: [],
                        tasks: [],
                        links: [],
                        images: imageDataArray
                    });
                }
                
                renderProjects();
                closeModal('project');
                editingProjectIndex = null;
                persistData();
            };
            
            processImages();
        }


        function triggerImageUpload(projectIndex) {
            document.getElementById(`projectImageUpload${projectIndex}`).click();
        }

        async function handleProjectImageUpload(event, projectIndex) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const imageDataArray = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const imageData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                imageDataArray.push(imageData);
            }
            
            if (!projects[projectIndex].images) {
                projects[projectIndex].images = [];
            }
            projects[projectIndex].images = [...projects[projectIndex].images, ...imageDataArray];
            renderProjects();
            persistData();
            // Reset file input
            event.target.value = '';
        }

        async function removeProjectImageByIndex(event, projectIndex, imageIndex, imageId) {
            event.stopPropagation();
            if (confirm('Remove this image?')) {
                const project = projects[projectIndex];
                
                // If image has an ID (from database), delete via API
                if (imageId && project.id) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/projects/${project.id}/images/${imageId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            // Remove from local array
                            project.images.splice(imageIndex, 1);
                            renderProjects();
                            await loadData(); // Reload from server
                        } else {
                            console.error('Failed to delete image from server');
                            alert('Failed to delete image from server');
                        }
                    } catch (error) {
                        console.error('Error deleting image:', error);
                        alert('Error deleting image');
                    }
                } else {
                    // Local-only image (not yet saved to server)
                    project.images.splice(imageIndex, 1);
                    renderProjects();
                    persistData();
                }
            }
        }

        function viewImage(imageSrc) {
            document.getElementById('imageModalImg').src = imageSrc;
            document.getElementById('imageModal').classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        // Version Info Modal
        function showVersionInfo() {
            const modal = document.getElementById('versionModal');
            modal.style.display = 'flex';
            
            // Close on click outside
            setTimeout(() => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeVersionModal();
                    }
                });
            }, 100);
        }

        function closeVersionModal() {
            document.getElementById('versionModal').style.display = 'none';
        }

        // Close image modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const imageModal = document.getElementById('imageModal');
            if (imageModal) {
                imageModal.addEventListener('click', function(e) {
                    if (e.target === imageModal) {
                        closeImageModal();
                    }
                });
            }
        });

        // Link management
        function toggleLinkInput(projectIndex) {
            const linkInput = document.getElementById(`linkInput${projectIndex}`);
            if (linkInput) {
                linkInput.style.display = linkInput.style.display === 'none' ? 'block' : 'none';
                if (linkInput.style.display === 'block') {
                    document.getElementById(`linkTitle${projectIndex}`).focus();
                }
            }
        }

        function addProjectLink(projectIndex) {
            const title = document.getElementById(`linkTitle${projectIndex}`).value.trim();
            const url = document.getElementById(`linkUrl${projectIndex}`).value.trim();
            
            if (!url) {
                alert('Please enter a valid URL');
                return;
            }
            
            // Add https:// if no protocol specified
            let fullUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                fullUrl = 'https://' + url;
            }
            
            if (!projects[projectIndex].links) {
                projects[projectIndex].links = [];
            }
            
            projects[projectIndex].links.push({
                title: title || fullUrl,
                url: fullUrl
            });
            
            // Clear inputs
            document.getElementById(`linkTitle${projectIndex}`).value = '';
            document.getElementById(`linkUrl${projectIndex}`).value = '';
            
            // Hide input and re-render
            toggleLinkInput(projectIndex);
            renderProjects();
            persistData();
        }

        function removeProjectLink(projectIndex, linkIndex) {
            if (confirm('Remove this link?')) {
                projects[projectIndex].links.splice(linkIndex, 1);
                renderProjects();
                persistData();
            }
        }

        function toggleMeetingMinutesEdit(projectIndex) {
            const contentDiv = document.getElementById(`meetingMinutes${projectIndex}`);
            const editDiv = document.getElementById(`meetingMinutesEdit${projectIndex}`);
            
            if (editDiv.style.display === 'none') {
                contentDiv.style.display = 'none';
                editDiv.style.display = 'block';
            } else {
                contentDiv.style.display = 'block';
                editDiv.style.display = 'none';
            }
        }

        function saveMeetingMinutes(projectIndex) {
            const textarea = document.getElementById(`meetingMinutesTextarea${projectIndex}`);
            const meetingMinutes = textarea.value.trim();
            
            projects[projectIndex].meetingMinutes = meetingMinutes;
            
            titleToggle = document.getElementById(`meetingMinutes${projectIndex}`);
            if (meetingMinutes) {
                titleToggle.innerHTML = `<div style="white-space: pre-wrap; word-break: break-word;">${meetingMinutes}</div>`;
            } else {
                titleToggle.innerHTML = `<div class="meeting-minutes-empty">No meeting minutes added yet</div>`;
            }
            
            toggleMeetingMinutesEdit(projectIndex);
            renderProjects();
            persistData();
        }

        // Delete project
        function deleteProject(projectIndex) {
            const project = projects[projectIndex];
            
            if (confirm(`Are you sure you want to delete "${project.name}"? This will remove all tasks and team assignments.`)) {
                // Remove project from all team members' project lists
                project.team.forEach(memberName => {
                    const member = teamMembers.find(m => m.name === memberName);
                    if (member) {
                        member.projects = member.projects.filter(p => p !== project.name);
                        member.workload = Math.max(0, member.workload - 25);
                    }
                });
                
                // Remove the project
                projects.splice(projectIndex, 1);
                
                renderProjects();
                renderTeam();
                persistData();
            }
        }

        // Drag and Drop handlers
        let draggedMember = null;

        function handleDragStart(e) {
            draggedMember = e.target.dataset.member;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.currentTarget.classList.remove('drag-over');
            
            const projectName = e.currentTarget.dataset.project;
            addMemberToProject(projectName, draggedMember);
            
            return false;
        }

        // Add member to project
        function addMemberToProject(projectName, memberName) {
            const project = projects.find(p => p.name === projectName);
            const member = teamMembers.find(m => m.name === memberName);
            
            if (!project) {
                console.error('Project not found:', projectName);
                return;
            }
            
            if (!member) {
                console.error('Member not found:', memberName);
                return;
            }
            
            if (project.team.includes(memberName)) {
                console.log('Member already on project');
                return;
            }
            
            project.team.push(memberName);
            
            // Update member's projects and workload
            if (!member.projects.includes(projectName)) {
                member.projects.push(projectName);
                member.workload = Math.min(100, member.workload + 25);
            }
            
            renderProjects();
            renderTeam();
            persistData();
        }

        // Remove member from project
        function removeMemberFromProject(projectName, memberName) {
            const project = projects.find(p => p.name === projectName);
            const member = teamMembers.find(m => m.name === memberName);
            
            if (project && member) {
                project.team = project.team.filter(m => m !== memberName);
                member.projects = member.projects.filter(p => p !== projectName);
                member.workload = Math.max(0, member.workload - 25);
                
                renderProjects();
                renderTeam();
                persistData();
            }
        }

        // Assign member modal
        let currentAssignProject = null;

        function openAssignModal(projectName) {
            currentAssignProject = projectName;
            document.getElementById('assignProjectName').textContent = projectName;
            
            const select = document.getElementById('assignMemberSelect');
            const project = projects.find(p => p.name === projectName);
            
            if (!project) {
                alert('Project not found');
                return;
            }
            
            const availableMembers = teamMembers.filter(m => !project.team.includes(m.name));
            
            if (availableMembers.length === 0) {
                if (teamMembers.length === 0) {
                    alert('No team members available. Please add team members first in the Team Overview tab.');
                    return;
                } else {
                    alert('All team members are already assigned to this project.');
                    return;
                }
            }
            
            select.innerHTML = availableMembers.map(m => 
                `<option value="${m.name}">${m.name} - ${m.role}</option>`
            ).join('');
            
            document.getElementById('assignModal').classList.add('active');
            
            // Add click outside to close
            setTimeout(() => {
                const modal = document.getElementById('assignModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeAssignModal();
                    }
                });
            }, 100);
        }

        function closeAssignModal() {
            document.getElementById('assignModal').classList.remove('active');
            currentAssignProject = null;
        }

        function assignMemberToProject() {
            const memberName = document.getElementById('assignMemberSelect').value;
            if (currentAssignProject && memberName) {
                addMemberToProject(currentAssignProject, memberName);
                closeAssignModal();
            }
        }

        // Project status management
        function toggleStatusDropdown(projectIndex) {
            const dropdown = document.getElementById(`statusDropdown${projectIndex}`);
            // Close all other dropdowns
            document.querySelectorAll('.status-dropdown').forEach(d => {
                if (d.id !== `statusDropdown${projectIndex}`) {
                    d.style.display = 'none';
                }
            });
            // Toggle current dropdown
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeDropdowns);
            }, 0);
        }

        function closeDropdowns(e) {
            if (!e.target.closest('.project-status')) {
                document.querySelectorAll('.status-dropdown').forEach(d => {
                    d.style.display = 'none';
                });
                document.removeEventListener('click', closeDropdowns);
            }
        }

        async function updateProjectStatus(projectIndex, newStatus) {
            const project = projects[projectIndex];
            project.status = newStatus;
            renderProjects();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }
        
        async function updateProjectDeliveryDate(projectIndex, newDate) {
            const project = projects[projectIndex];
            project.deliveryDate = newDate || null;
            renderProjects();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }

        // Task Management
        function showTaskInput(projectIndex) {
            const input = document.getElementById(`taskInput${projectIndex}`);
            input.style.display = input.style.display === 'none' ? 'flex' : 'none';
            if (input.style.display === 'flex') {
                document.getElementById(`taskText${projectIndex}`).focus();
            }
        }

        async function addTask(projectIndex) {
            const input = document.getElementById(`taskText${projectIndex}`);
            const taskText = input.value.trim();
            
            if (taskText) {
                const project = projects[projectIndex];
                const newTask = {
                    id: Date.now(),
                    text: taskText,
                    completed: false,
                    assignee: null,
                    startDate: null,
                    endDate: null
                };
                
                if (!project.tasks) {
                    project.tasks = [];
                }
                
                project.tasks.push(newTask);
                input.value = '';
                renderProjects();
                
                // Update to database if project has ID
                if (project.id) {
                    await updateProjectToDatabase(project);
                } else {
                    await persistData();
                }
            }
        }

        async function toggleTask(projectIndex, taskIndex) {
            const project = projects[projectIndex];
            project.tasks[taskIndex].completed = !project.tasks[taskIndex].completed;
            renderProjects();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }

        async function deleteTask(projectIndex, taskIndex) {
            if (confirm('Delete this task?')) {
                const project = projects[projectIndex];
                project.tasks.splice(taskIndex, 1);
                renderProjects();
                
                // Update to database if project has ID
                if (project.id) {
                    await updateProjectToDatabase(project);
                } else {
                    await persistData();
                }
            }
        }

        // Edit Task
        let editingTask = null;

        function editTask(projectIndex, taskIndex) {
            editingTask = { projectIndex, taskIndex };
            const project = projects[projectIndex];
            const task = project.tasks[taskIndex];
            
            // Populate form
            document.getElementById('editTaskText').value = task.text;
            document.getElementById('editTaskStartDate').value = task.startDate || '';
            document.getElementById('editTaskEndDate').value = task.endDate || '';
            
            // Populate assignee dropdown
            const assigneeSelect = document.getElementById('editTaskAssignee');
            assigneeSelect.innerHTML = '<option value="">Unassigned</option>';
            
            project.team.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                if (task.assignee === member) {
                    option.selected = true;
                }
                assigneeSelect.appendChild(option);
            });
            
            // Show modal
            document.getElementById('taskEditModal').classList.add('active');
            
            // Add click outside to close
            setTimeout(() => {
                const modal = document.getElementById('taskEditModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeTaskEditModal();
                    }
                });
            }, 100);
        }

        function closeTaskEditModal() {
            document.getElementById('taskEditModal').classList.remove('active');
            editingTask = null;
        }

        async function saveTaskEdit() {
            if (!editingTask) return;
            
            const text = document.getElementById('editTaskText').value.trim();
            const startDate = document.getElementById('editTaskStartDate').value;
            const endDate = document.getElementById('editTaskEndDate').value;
            const assignee = document.getElementById('editTaskAssignee').value;
            
            if (!text) {
                alert('Please enter a task description');
                return;
            }
            
            const project = projects[editingTask.projectIndex];
            const task = project.tasks[editingTask.taskIndex];
            task.text = text;
            task.startDate = startDate || null;
            task.endDate = endDate || null;
            task.assignee = assignee || null;
            
            renderProjects();
            closeTaskEditModal();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }

        // Task Assignee Management
        let assigneeDropdown = null;

        function showAssigneeDropdown(event, projectIndex, taskIndex) {
            event.stopPropagation();
            
            const project = projects[projectIndex];
            const task = project.tasks[taskIndex];
            
            // Check if project has team members
            if (project.team.length === 0) {
                alert('No team members on this project yet!\n\nPlease assign team members to the project first using:\n• Drag & drop from Team Overview tab, or\n• Click "+ Assign Member" button on the project card');
                return;
            }
            
            // Remove existing dropdown
            if (assigneeDropdown) {
                assigneeDropdown.remove();
            }
            
            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'assignee-dropdown';
            dropdown.style.position = 'fixed';
            
            // Smart positioning - check if there's room below
            const spaceBelow = window.innerHeight - event.clientY;
            const spaceAbove = event.clientY;
            const dropdownHeight = Math.min(200, (project.team.length + 1) * 40); // Approximate height
            
            if (spaceBelow < dropdownHeight && spaceAbove > dropdownHeight) {
                // Position above the click if not enough space below
                dropdown.style.left = event.clientX + 'px';
                dropdown.style.bottom = (window.innerHeight - event.clientY + 10) + 'px';
            } else {
                // Position below the click (default)
                dropdown.style.left = event.clientX + 'px';
                dropdown.style.top = (event.clientY + 10) + 'px';
            }
            
            // Make sure it doesn't go off the right edge
            const maxLeft = window.innerWidth - 200; // 180px width + 20px margin
            if (event.clientX > maxLeft) {
                dropdown.style.left = maxLeft + 'px';
            }
            
            // Add team members to dropdown
            let options = '';
            
            // Option to unassign
            if (task.assignee) {
                options += `
                    <div class="assignee-option" onclick="assignTaskTo(${projectIndex}, ${taskIndex}, null)">
                        <span>Unassign</span>
                    </div>
                `;
            }
            
            // Add all project team members
            project.team.forEach(member => {
                const teamMember = teamMembers.find(m => m.name === member);
                options += `
                    <div class="assignee-option" onclick="assignTaskTo(${projectIndex}, ${taskIndex}, '${member}')">
                        <span>${member}</span>
                        <span class="role-badge">${teamMember ? teamMember.role : ''}</span>
                    </div>
                `;
            });
            
            dropdown.innerHTML = options;
            document.body.appendChild(dropdown);
            assigneeDropdown = dropdown;
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeAssigneeDropdown);
            }, 0);
        }

        function closeAssigneeDropdown() {
            if (assigneeDropdown) {
                assigneeDropdown.remove();
                assigneeDropdown = null;
            }
            document.removeEventListener('click', closeAssigneeDropdown);
        }

        async function assignTaskTo(projectIndex, taskIndex, memberName) {
            const project = projects[projectIndex];
            project.tasks[taskIndex].assignee = memberName;
            renderProjects();
            closeAssigneeDropdown();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }

        // Task Date Management
        let datePickerPopup = null;
        let currentDateTask = null;

        function showDatePicker(event, projectIndex, taskIndex) {
            event.stopPropagation();
            
            // Remove existing popup
            if (datePickerPopup) {
                datePickerPopup.remove();
            }
            
            currentDateTask = { projectIndex, taskIndex };
            const task = projects[projectIndex].tasks[taskIndex];
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'date-picker-popup';
            popup.style.position = 'fixed';
            
            // Smart positioning - check if there's room below
            const spaceBelow = window.innerHeight - event.clientY;
            const spaceAbove = event.clientY;
            const popupHeight = 200; // Approximate height of the date picker
            
            if (spaceBelow < popupHeight && spaceAbove > popupHeight) {
                // Position above the click if not enough space below
                popup.style.left = event.clientX + 'px';
                popup.style.bottom = (window.innerHeight - event.clientY + 10) + 'px';
            } else {
                // Position below the click (default)
                popup.style.left = event.clientX + 'px';
                popup.style.top = (event.clientY + 10) + 'px';
            }
            
            // Make sure it doesn't go off the right edge
            const maxLeft = window.innerWidth - 270; // 250px width + 20px margin
            if (event.clientX > maxLeft) {
                popup.style.left = maxLeft + 'px';
            }
            
            popup.innerHTML = `
                <div class="date-picker-header">Set Task Dates</div>
                <div class="date-picker-group">
                    <div class="date-picker-label">Start Date</div>
                    <input type="date" class="date-picker-input" id="taskStartDate" value="${task.startDate || ''}">
                </div>
                <div class="date-picker-group">
                    <div class="date-picker-label">End Date</div>
                    <input type="date" class="date-picker-input" id="taskEndDate" value="${task.endDate || ''}">
                </div>
                <div class="date-picker-actions">
                    <button class="date-picker-btn save" onclick="saveDates()">Save</button>
                    <button class="date-picker-btn cancel" onclick="closeDatePicker()">Cancel</button>
                </div>
            `;
            
            document.body.appendChild(popup);
            datePickerPopup = popup;
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeDatePickerOutside);
            }, 0);
        }

        function closeDatePicker() {
            if (datePickerPopup) {
                datePickerPopup.remove();
                datePickerPopup = null;
            }
            currentDateTask = null;
            document.removeEventListener('click', closeDatePickerOutside);
        }

        function closeDatePickerOutside(e) {
            if (datePickerPopup && !datePickerPopup.contains(e.target)) {
                closeDatePicker();
            }
        }

        async function saveDates() {
            if (currentDateTask) {
                const startDate = document.getElementById('taskStartDate').value;
                const endDate = document.getElementById('taskEndDate').value;
                
                const project = projects[currentDateTask.projectIndex];
                const task = project.tasks[currentDateTask.taskIndex];
                task.startDate = startDate || null;
                task.endDate = endDate || null;
                
                renderProjects();
                closeDatePicker();
                
                // Update to database if project has ID
                if (project.id) {
                    await updateProjectToDatabase(project);
                } else {
                    await persistData();
                }
            }
        }

        // Subtask Management Functions
        function toggleSubtaskInput(projectIndex, taskIndex) {
            const input = document.getElementById(`subtaskInput${projectIndex}-${taskIndex}`);
            if (input) {
                const isHidden = input.style.display === 'none';
                input.style.display = isHidden ? 'block' : 'none';
                if (isHidden) {
                    setTimeout(() => {
                        document.getElementById(`subtaskText${projectIndex}-${taskIndex}`).focus();
                    }, 0);
                }
            }
        }

        async function addSubtask(projectIndex, taskIndex) {
            const input = document.getElementById(`subtaskText${projectIndex}-${taskIndex}`);
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a subtask description');
                return;
            }
            
            const project = projects[projectIndex];
            const task = project.tasks[taskIndex];
            if (!task.subtasks) {
                task.subtasks = [];
            }
            
            task.subtasks.push({
                text: text,
                completed: false
            });
            
            input.value = '';
            renderProjects();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }

        async function toggleSubtask(projectIndex, taskIndex, subtaskIndex) {
            const project = projects[projectIndex];
            const subtask = project.tasks[taskIndex].subtasks[subtaskIndex];
            subtask.completed = !subtask.completed;
            renderProjects();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }

        async function deleteSubtask(projectIndex, taskIndex, subtaskIndex) {
            if (confirm('Delete this subtask?')) {
                const project = projects[projectIndex];
                project.tasks[taskIndex].subtasks.splice(subtaskIndex, 1);
                renderProjects();
                
                // Update to database if project has ID
                if (project.id) {
                    await updateProjectToDatabase(project);
                } else {
                    await persistData();
                }
            }
        }

        // Edit Subtask
        let editingSubtask = null;

        function editSubtask(projectIndex, taskIndex, subtaskIndex) {
            editingSubtask = { projectIndex, taskIndex, subtaskIndex };
            const project = projects[projectIndex];
            const subtask = project.tasks[taskIndex].subtasks[subtaskIndex];
            
            // Populate form
            document.getElementById('editSubtaskText').value = subtask.text;
            
            // Populate assignee dropdown
            const assigneeSelect = document.getElementById('editSubtaskAssignee');
            assigneeSelect.innerHTML = '<option value="">Unassigned</option>';
            
            project.team.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                if (subtask.assignee === member) {
                    option.selected = true;
                }
                assigneeSelect.appendChild(option);
            });
            
            // Show modal
            document.getElementById('subtaskEditModal').classList.add('active');
            
            // Add click outside to close
            setTimeout(() => {
                const modal = document.getElementById('subtaskEditModal');
                const clickHandler = (e) => {
                    if (e.target === modal) {
                        closeSubtaskEditModal();
                    }
                };
                modal.addEventListener('click', clickHandler);
                modal._clickHandler = clickHandler;
            }, 100);
        }

        function closeSubtaskEditModal() {
            const modal = document.getElementById('subtaskEditModal');
            modal.classList.remove('active');
            if (modal._clickHandler) {
                modal.removeEventListener('click', modal._clickHandler);
            }
            editingSubtask = null;
        }

        async function saveSubtaskEdit() {
            if (!editingSubtask) return;
            
            const text = document.getElementById('editSubtaskText').value.trim();
            const assignee = document.getElementById('editSubtaskAssignee').value;
            
            if (!text) {
                alert('Please enter a subtask description');
                return;
            }
            
            const project = projects[editingSubtask.projectIndex];
            const subtask = project.tasks[editingSubtask.taskIndex].subtasks[editingSubtask.subtaskIndex];
            subtask.text = text;
            subtask.assignee = assignee || null;
            
            renderProjects();
            closeSubtaskEditModal();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }

        // Subtask assignee dropdown
        let subtaskAssigneeDropdown = null;

        function showSubtaskAssigneeDropdown(event, projectIndex, taskIndex, subtaskIndex) {
            event.stopPropagation();
            
            // Close existing dropdown
            if (subtaskAssigneeDropdown) {
                subtaskAssigneeDropdown.remove();
            }
            
            const project = projects[projectIndex];
            let options = '';
            
            // Option to unassign
            options += `<div class="assignee-option" onclick="assignSubtaskTo(${projectIndex}, ${taskIndex}, ${subtaskIndex}, null)" style="border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 8px;">
                <span style="color: #999;">Unassign</span>
            </div>`;
            
            // Add team members
            project.team.forEach(member => {
                const teamMember = teamMembers.find(m => m.name === member);
                options += `
                    <div class="assignee-option" onclick="assignSubtaskTo(${projectIndex}, ${taskIndex}, ${subtaskIndex}, '${member}')">
                        <span>${member}</span>
                        <span class="role-badge">${teamMember ? teamMember.role : ''}</span>
                    </div>
                `;
            });
            
            const dropdown = document.createElement('div');
            dropdown.className = 'assignee-dropdown';
            dropdown.style.position = 'fixed';
            dropdown.style.top = (event.clientY + 10) + 'px';
            dropdown.style.left = (event.clientX - 100) + 'px';
            dropdown.style.zIndex = '1000';
            dropdown.innerHTML = options;
            
            document.body.appendChild(dropdown);
            subtaskAssigneeDropdown = dropdown;
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeSubtaskAssigneeDropdown);
            }, 0);
        }

        function closeSubtaskAssigneeDropdown() {
            if (subtaskAssigneeDropdown) {
                subtaskAssigneeDropdown.remove();
                subtaskAssigneeDropdown = null;
            }
            document.removeEventListener('click', closeSubtaskAssigneeDropdown);
        }

        async function assignSubtaskTo(projectIndex, taskIndex, subtaskIndex, memberName) {
            const project = projects[projectIndex];
            project.tasks[taskIndex].subtasks[subtaskIndex].assignee = memberName;
            renderProjects();
            closeSubtaskAssigneeDropdown();
            
            // Update to database if project has ID
            if (project.id) {
                await updateProjectToDatabase(project);
            } else {
                await persistData();
            }
        }

        // Initialize: try loading data from server, fall back to embedded sample data
        async function initFromServer() {
            try {
                const res = await fetch('/api/data');
                if (res.ok) {
                    const d = await res.json();
                    if (d.teamMembers && Array.isArray(d.teamMembers)) teamMembers = d.teamMembers;
                    if (d.projects && Array.isArray(d.projects)) projects = d.projects;
                }
            } catch (e) {
                console.error('Failed to load server data:', e);
            }

            renderTeam();
            renderProjects();
        }

        initFromServer();

        // Dashboard Functions
        function renderDashboard() {
            // Render master timeline first
            renderMasterTimeline();
            
            const dashboardView = document.getElementById('dashboardView');
            
            // Group projects by channel, then by application
            const channelGroups = {};
            
            projects.forEach(project => {
                const channels = project.channels && project.channels.length > 0 
                    ? project.channels 
                    : ['No Channel'];
                const applications = project.applications && project.applications.length > 0 
                    ? project.applications 
                    : ['No Application'];
                
                channels.forEach(channel => {
                    if (!channelGroups[channel]) {
                        channelGroups[channel] = {};
                    }
                    
                    applications.forEach(app => {
                        if (!channelGroups[channel][app]) {
                            channelGroups[channel][app] = [];
                        }
                        channelGroups[channel][app].push(project);
                    });
                });
            });
            
            // Render hierarchy
            let html = '';
            
            const channelOrder = ['Agent', 'Partnership', 'Direct marketing', 'No Channel'];
            const sortedChannels = Object.keys(channelGroups).sort((a, b) => {
                const aIndex = channelOrder.indexOf(a);
                const bIndex = channelOrder.indexOf(b);
                if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            
            if (sortedChannels.length === 0) {
                html = '<div class="dashboard-empty">📊 No data to display. Add projects with channels and applications to see the dashboard.</div>';
            } else {
                sortedChannels.forEach(channel => {
                    const applications = channelGroups[channel];
                    const totalProjects = Object.values(applications).flat().length;
                    const totalTasks = Object.values(applications).flat()
                        .reduce((sum, p) => sum + (p.tasks ? p.tasks.length : 0), 0);
                    
                    html += `
                        <div class="dashboard-channel">
                            <div class="dashboard-channel-header" onclick="toggleDashboardSection('channel-${channel}')">
                                <div class="dashboard-channel-title">
                                    <span class="dashboard-expand-icon" id="icon-channel-${channel}">▶</span>
                                    📢 ${channel}
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <span class="dashboard-count">${totalProjects} projects</span>
                                    <span class="dashboard-count">${totalTasks} tasks</span>
                                </div>
                            </div>
                            <div id="channel-${channel}" style="display: none;">
                                ${renderApplications(applications, channel)}
                            </div>
                        </div>
                    `;
                });
            }
            
            dashboardView.innerHTML = html;
        }

        function renderMasterTimeline() {
            const masterTimeline = document.getElementById('masterTimeline');
            const currentYear = new Date().getFullYear();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Get selected assignee filter
            const assigneeFilter = document.getElementById('timelineAssigneeFilter');
            const selectedAssignee = assigneeFilter ? assigneeFilter.value : 'all';
            
            // Get selected completed month filter
            const completedMonthFilter = document.getElementById('timelineCompletedMonthFilter');
            const selectedMonth = completedMonthFilter ? completedMonthFilter.value : 'all';
            
            // Collect all unique assignees and update filter dropdown
            const allAssignees = new Set();
            projects.forEach(project => {
                const tasks = project.tasks || [];
                tasks.forEach(task => {
                    if (task.assignee) {
                        allAssignees.add(task.assignee);
                    }
                });
            });
            
            // Update filter dropdown if it exists
            if (assigneeFilter) {
                const currentValue = assigneeFilter.value;
                assigneeFilter.innerHTML = '<option value="all">All Assignees</option>';
                Array.from(allAssignees).sort().forEach(assignee => {
                    const option = document.createElement('option');
                    option.value = assignee;
                    option.textContent = assignee;
                    if (assignee === currentValue) {
                        option.selected = true;
                    }
                    assigneeFilter.appendChild(option);
                });
            }
            
            // Helper function to get ISO week number
            function getWeekNumber(date) {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            }
            
            // Build week structure based on actual calendar
            const weekStructure = [];
            const monthWeekMapping = {}; // Track which weeks belong to which months
            
            // Go through each month
            for (let monthIdx = 0; monthIdx < 12; monthIdx++) {
                const daysInMonth = new Date(currentYear, monthIdx + 1, 0).getDate();
                const weeksInMonth = new Set();
                
                // Find all unique weeks in this month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, monthIdx, day);
                    const weekNum = getWeekNumber(date);
                    weeksInMonth.add(weekNum);
                }
                
                monthWeekMapping[monthIdx] = Array.from(weeksInMonth).sort((a, b) => a - b);
            }
            
            // Create week structure for all weeks in the year (1 through 52 or 53)
            const lastDay = new Date(currentYear, 11, 31);
            const lastWeek = getWeekNumber(lastDay);
            const totalWeeksInYear = lastWeek; // This will be 52 or 53
            
            // Build sequential week structure from week 1 to last week of the year
            for (let weekNum = 1; weekNum <= totalWeeksInYear; weekNum++) {
                // Find which month this week primarily belongs to
                let primaryMonth = 0;
                for (let m = 0; m < 12; m++) {
                    if (monthWeekMapping[m].includes(weekNum)) {
                        primaryMonth = m;
                        break;
                    }
                }
                
                weekStructure.push({
                    weekNumber: weekNum,
                    month: months[primaryMonth],
                    monthIndex: primaryMonth
                });
            }
            
            const totalWeeks = weekStructure.length;
            
            // Group data hierarchically: Channel > Application > Project > Tasks
            const hierarchy = {};
            
            projects.forEach(project => {
                const channels = project.channels && project.channels.length > 0 ? project.channels : ['No Channel'];
                const applications = project.applications && project.applications.length > 0 ? project.applications : ['No Application'];
                
                channels.forEach(channel => {
                    if (!hierarchy[channel]) {
                        hierarchy[channel] = {};
                    }
                    
                    applications.forEach(app => {
                        if (!hierarchy[channel][app]) {
                            hierarchy[channel][app] = {};
                        }
                        
                        if (!hierarchy[channel][app][project.name]) {
                            hierarchy[channel][app][project.name] = {
                                projectData: project,
                                tasks: []
                            };
                        }
                        
                        const tasks = project.tasks || [];
                        // Include ALL tasks, regardless of whether they have dates or not
                        // This shows: completed, in-progress, overdue, scheduled, and unscheduled tasks
                        tasks.forEach(task => {
                            // Apply assignee filter
                            if (selectedAssignee === 'all' || task.assignee === selectedAssignee) {
                                hierarchy[channel][app][project.name].tasks.push(task);
                            }
                        });
                    });
                });
            });
            
            // Filter projects by completed status and month if filter is active
            if (selectedMonth !== 'all') {
                Object.keys(hierarchy).forEach(channel => {
                    Object.keys(hierarchy[channel]).forEach(app => {
                        Object.keys(hierarchy[channel][app]).forEach(proj => {
                            const projectData = hierarchy[channel][app][proj].projectData;
                            
                            // When month filter is active, only show completed projects from that month
                            // Hide all other projects (including non-completed ones)
                            if (projectData.status !== 'completed') {
                                // Remove non-completed projects
                                delete hierarchy[channel][app][proj];
                            } else if (!projectData.deliveryDate) {
                                // Remove completed projects without delivery date
                                delete hierarchy[channel][app][proj];
                            } else {
                                // Check if delivery date month matches selected month
                                const deliveryDate = new Date(projectData.deliveryDate);
                                const deliveryMonth = deliveryDate.getMonth();
                                if (deliveryMonth !== parseInt(selectedMonth)) {
                                    // Remove completed projects from other months
                                    delete hierarchy[channel][app][proj];
                                }
                            }
                        });
                    });
                });
            }
            
            // Clean up hierarchy: remove projects with no tasks, apps with no projects, channels with no apps
            Object.keys(hierarchy).forEach(channel => {
                Object.keys(hierarchy[channel]).forEach(app => {
                    Object.keys(hierarchy[channel][app]).forEach(proj => {
                        // Remove projects with no tasks
                        if (hierarchy[channel][app][proj].tasks.length === 0) {
                            delete hierarchy[channel][app][proj];
                        }
                    });
                    // Remove apps with no projects
                    if (Object.keys(hierarchy[channel][app]).length === 0) {
                        delete hierarchy[channel][app];
                    }
                });
                // Remove channels with no apps
                if (Object.keys(hierarchy[channel]).length === 0) {
                    delete hierarchy[channel];
                }
            });
            
            // Check if we have any data
            let hasData = false;
            Object.keys(hierarchy).forEach(channel => {
                Object.keys(hierarchy[channel]).forEach(app => {
                    Object.keys(hierarchy[channel][app]).forEach(proj => {
                        if (hierarchy[channel][app][proj].tasks.length > 0) {
                            hasData = true;
                        }
                    });
                });
            });
            
            if (!hasData) {
                let filterMessage = 'No tasks to display. Add tasks to projects to see the master timeline.';
                
                if (selectedMonth !== 'all' && selectedAssignee !== 'all') {
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    filterMessage = `No completed projects found for ${monthNames[parseInt(selectedMonth)]} with assignee: ${selectedAssignee}.`;
                } else if (selectedMonth !== 'all') {
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    filterMessage = `No completed projects found for ${monthNames[parseInt(selectedMonth)]}.`;
                } else if (selectedAssignee !== 'all') {
                    filterMessage = `No tasks found for assignee: ${selectedAssignee}. Try selecting a different assignee.`;
                }
                
                masterTimeline.innerHTML = `
                    <div class="master-timeline">
                        <div style="text-align: center; padding: 40px; color: #a0aec0;">
                            📅 ${filterMessage}
                        </div>
                    </div>
                `;
                return;
            }
            
            // Calculate today position in weeks
            const today = new Date();
            const todayWeekNum = getWeekNumber(today);
            
            // Find today's position in the week structure
            let todayWeekIndex = weekStructure.findIndex(w => w.weekNumber === todayWeekNum);
            if (todayWeekIndex === -1) todayWeekIndex = 0;
            
            // Helper function to render timeline bar
            function renderTimelineBar(item, startDate, endDate, isProject = false) {
                // If task has no dates at all, show empty cells with today marker if applicable
                if (!startDate && !endDate) {
                    return weekStructure.map((week, idx) => {
                        const isTodayWeek = idx === todayWeekIndex;
                        return `
                            <div class="master-timeline-cell" style="position: relative;">
                                ${idx === 0 ? '<div class="no-date-indicator" title="No dates set">⊝</div>' : ''}
                                ${isTodayWeek ? '<div class="master-timeline-today-marker"></div>' : ''}
                            </div>
                        `;
                    }).join('');
                }
                
                // Calculate week positions
                let startWeek = 0;
                let endWeek = totalWeeks - 1;
                let shouldDisplay = false;
                
                if (startDate) {
                    if (startDate.getFullYear() === currentYear) {
                        const startWeekNum = getWeekNumber(startDate);
                        startWeek = weekStructure.findIndex(w => w.weekNumber === startWeekNum);
                        if (startWeek === -1) startWeek = 0;
                        shouldDisplay = true;
                    } else if (startDate.getFullYear() < currentYear) {
                        startWeek = 0;
                        shouldDisplay = true;
                    }
                } else {
                    shouldDisplay = true;
                }
                
                if (endDate) {
                    if (endDate.getFullYear() === currentYear) {
                        const endWeekNum = getWeekNumber(endDate);
                        endWeek = weekStructure.findIndex(w => w.weekNumber === endWeekNum);
                        if (endWeek === -1) endWeek = totalWeeks - 1;
                        shouldDisplay = true;
                    } else if (endDate.getFullYear() > currentYear) {
                        endWeek = totalWeeks - 1;
                        shouldDisplay = true;
                    } else if (endDate.getFullYear() < currentYear) {
                        if (!startDate || startDate.getFullYear() < currentYear) {
                            shouldDisplay = false;
                        }
                    }
                } else {
                    shouldDisplay = true;
                }
                
                if (!shouldDisplay) {
                    return weekStructure.map((w, idx) => {
                        return `<div class="master-timeline-cell"></div>`;
                    }).join('');
                }
                
                const widthInWeeks = Math.max(endWeek - startWeek + 1, 1);
                const isCompleted = item.completed;
                const isOverdue = endDate && endDate < today && !item.completed;
                const barClass = isCompleted ? 'completed' : (isOverdue ? 'overdue' : '');
                
                // Create exactly one cell per week, with explicit grid column positioning
                let result = [];
                for (let weekIdx = 0; weekIdx < weekStructure.length; weekIdx++) {
                    const isTodayWeek = weekIdx === todayWeekIndex;
                    
                    if (weekIdx < startWeek || weekIdx > endWeek) {
                        // Empty cell for weeks outside the task's range
                        result.push(`<div class="master-timeline-cell" style="position: relative;">${isTodayWeek ? '<div class="master-timeline-today-marker"></div>' : ''}</div>`);
                    } else if (weekIdx === startWeek) {
                        // Starting cell with the bar that spans multiple weeks
                        const gridColumn = `${weekIdx + 2} / span ${widthInWeeks}`; // +2 for Item column
                        const hasTodayMarker = isTodayWeek || (todayWeekIndex >= startWeek && todayWeekIndex <= endWeek);
                        result.push(`
                            <div class="master-timeline-cell" style="grid-column: ${gridColumn}; position: relative;">
                                <div class="master-timeline-bar ${barClass}" 
                                     style="width: 100%; height: 80%; top: 10%; left: 0; position: absolute;"
                                     title="${isProject ? 'Project' : 'Task'}: ${item.text || item.name}
${item.assignee ? 'Assignee: ' + item.assignee : ''}
Start: ${startDate ? startDate.toLocaleDateString() : '—'}
End: ${endDate ? endDate.toLocaleDateString() : '—'}">
                                </div>
                                ${hasTodayMarker ? `<div class="master-timeline-today-marker" style="left: ${((todayWeekIndex - startWeek) / widthInWeeks) * 100 + (50 / widthInWeeks)}%;"></div>` : ''}
                            </div>
                        `);
                        // Skip the weeks that are covered by the span
                        weekIdx += widthInWeeks - 1;
                    } else {
                        // Empty cell
                        result.push(`
                            <div class="master-timeline-cell">
                            </div>
                        `);
                    }
                }
                
                return result.join('');
            }
            
            // Build HTML
            let rowHtml = '';
            
            const channelOrder = ['Agent', 'Partnership', 'Direct marketing', 'No Channel'];
            const sortedChannels = Object.keys(hierarchy).sort((a, b) => {
                const aIndex = channelOrder.indexOf(a);
                const bIndex = channelOrder.indexOf(b);
                if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            
            sortedChannels.forEach(channel => {
                const apps = hierarchy[channel];
                
                // LEVEL 1: Channel Header
                rowHtml += `
                    <div class="master-timeline-row-header master-timeline-channel" style="grid-column: 1 / -1; font-size: 16px; font-weight: 700; padding: 12px;">
                        📢 ${channel}
                    </div>
                `;
                
                Object.keys(apps).sort().forEach(app => {
                    const projects = apps[app];
                    
                    // LEVEL 2: Application Header
                    const appClass = app.toLowerCase().replace(/\s+/g, '-');
                    rowHtml += `
                        <div class="master-timeline-row-header master-timeline-app" style="grid-column: 1 / -1; font-size: 14px; font-weight: 600; padding: 10px 20px;">
                            <span class="application-badge app-${appClass} selected" style="cursor: default;">💻 ${app}</span>
                        </div>
                    `;
                    
                    // Sort projects: starred first, then alphabetically by name
                    const sortedProjectNames = Object.keys(projects).sort((a, b) => {
                        const projectA = projects[a].projectData;
                        const projectB = projects[b].projectData;
                        
                        // Sort by starred status first (starred = true comes first)
                        if (projectA.starred && !projectB.starred) return -1;
                        if (!projectA.starred && projectB.starred) return 1;
                        
                        // If both have same starred status, sort alphabetically
                        return a.localeCompare(b);
                    });
                    
                    sortedProjectNames.forEach(projectName => {
                        const projectInfo = projects[projectName];
                        const projectData = projectInfo.projectData;
                        const tasks = projectInfo.tasks;
                        
                        // Calculate project timeline (earliest start to latest end)
                        let projectStart = null;
                        let projectEnd = null;
                        tasks.forEach(task => {
                            if (task.startDate) {
                                const sd = new Date(task.startDate);
                                if (!projectStart || sd < projectStart) projectStart = sd;
                            }
                            if (task.endDate) {
                                const ed = new Date(task.endDate);
                                if (!projectEnd || ed > projectEnd) projectEnd = ed;
                            }
                        });
                        
                        // LEVEL 3: Project Row
                        rowHtml += `
                            <div class="master-timeline-row-header master-timeline-project" style="padding-left: 40px;">
                                <div>
                                    <div class="clickable-project-name" onclick="navigateToProject('${projectName.replace(/'/g, "\\'")}')"
                                          title="Click to view project in Projects tab">
                                        📁 ${projectName} ${projectData.starred ? '⭐' : ''}
                                    </div>
                                    <div style="margin-top: 3px; font-size: 11px; display: flex; gap: 10px; align-items: center;">
                                        <span class="project-status status-${projectData.status}" style="font-size: 10px; padding: 2px 6px;">
                                            ${projectData.status}
                                        </span>
                                        ${projectData.deliveryDate ? `<span style="color: #666;">📅 ${(() => {
                                            const d = new Date(projectData.deliveryDate);
                                            const day = String(d.getDate()).padStart(2, '0');
                                            const month = String(d.getMonth() + 1).padStart(2, '0');
                                            const year = d.getFullYear();
                                            return day + '/' + month + '/' + year;
                                        })()}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${renderTimelineBar({name: projectName, completed: false}, projectStart, projectEnd, true)}
                        `;
                        
                        // LEVEL 4: Task Rows
                        // Sort tasks: incomplete first, completed at bottom
                        const sortedTasks = tasks.sort((a, b) => {
                            // Sort by completion status (incomplete = false comes first)
                            if (!a.completed && b.completed) return -1;
                            if (a.completed && !b.completed) return 1;
                            
                            // If both have same completion status, maintain relative order
                            return 0;
                        });
                        
                        sortedTasks.forEach(task => {
                            const startDate = task.startDate ? new Date(task.startDate) : null;
                            const endDate = task.endDate ? new Date(task.endDate) : null;
                            
                            rowHtml += `
                                <div class="master-timeline-row-header master-timeline-task" style="padding-left: 60px;">
                                    ${task.completed ? '✅' : '⏳'} ${task.text}
                                    ${task.assignee ? `<span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 6px;">${task.assignee}</span>` : ''}
                                </div>
                                ${renderTimelineBar(task, startDate, endDate, false)}
                            `;
                        });
                    });
                });
            });
            
            let html = `
                <div class="master-timeline">
                    <div class="master-timeline-header">
                        <div class="master-timeline-title">📅 ${currentYear} Master Project Timeline (Weekly View)</div>
                        <div class="master-timeline-legend">
                            <div class="master-timeline-legend-item">
                                <div class="master-timeline-legend-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                                <span>In Progress</span>
                            </div>
                            <div class="master-timeline-legend-item">
                                <div class="master-timeline-legend-box" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);"></div>
                                <span>Completed</span>
                            </div>
                            <div class="master-timeline-legend-item">
                                <div class="master-timeline-legend-box" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);"></div>
                                <span>Overdue</span>
                            </div>
                            <div class="master-timeline-legend-item">
                                <div style="width: 3px; height: 14px; background: #ed8936;"></div>
                                <span>Today</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="master-timeline-grid">
                        <!-- Month Headers -->
                        <div class="master-timeline-header-cell">Item</div>
                        ${(() => {
                            let lastMonth = -1;
                            let monthSpan = 0;
                            let monthStartCol = 2;
                            let result = [];
                            
                            weekStructure.forEach((week, idx) => {
                                if (week.monthIndex !== lastMonth) {
                                    if (lastMonth !== -1 && monthSpan > 0) {
                                        result.push(`<div class="master-timeline-month-header" style="grid-column: ${monthStartCol} / span ${monthSpan};">${months[lastMonth]}</div>`);
                                        monthStartCol += monthSpan;
                                    }
                                    lastMonth = week.monthIndex;
                                    monthSpan = 1;
                                } else {
                                    monthSpan++;
                                }
                            });
                            
                            // Add last month
                            if (monthSpan > 0) {
                                result.push(`<div class="master-timeline-month-header" style="grid-column: ${monthStartCol} / span ${monthSpan};">${months[lastMonth]}</div>`);
                            }
                            
                            return result.join('');
                        })()}
                        
                        <!-- Week Headers -->
                        <div class="master-timeline-header-cell" style="font-size: 8px;">Week #</div>
                        ${weekStructure.map(w => `<div class="master-timeline-header-cell">${w.weekNumber}</div>`).join('')}
                        
                        <!-- Data Rows -->
                        ${rowHtml}
                    </div>
                </div>
            `;
            
            masterTimeline.innerHTML = html;
        }

        function renderApplications(applications, channelName) {
            let html = '';
            
            Object.keys(applications).sort().forEach(appName => {
                const projectsList = applications[appName];
                
                // Sort projects: starred first, then alphabetically by name
                const sortedProjectsList = projectsList.sort((a, b) => {
                    // Sort by starred status first (starred = true comes first)
                    if (a.starred && !b.starred) return -1;
                    if (!a.starred && b.starred) return 1;
                    
                    // If both have same starred status, sort alphabetically
                    return a.name.localeCompare(b.name);
                });
                
                const totalTasks = sortedProjectsList.reduce((sum, p) => sum + (p.tasks ? p.tasks.length : 0), 0);
                const appClass = appName.toLowerCase().replace(/\s+/g, '-');
                
                html += `
                    <div class="dashboard-application">
                        <div class="dashboard-application-header" onclick="toggleDashboardSection('app-${channelName}-${appName}')">
                            <div class="dashboard-application-title">
                                <span class="dashboard-expand-icon" id="icon-app-${channelName}-${appName}">▶</span>
                                <span class="application-badge app-${appClass} selected" style="cursor: default;">
                                    ${appName}
                                </span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <span class="dashboard-count">${sortedProjectsList.length} projects</span>
                                <span class="dashboard-count">${totalTasks} tasks</span>
                            </div>
                        </div>
                        <div id="app-${channelName}-${appName}" style="display: none;">
                            ${renderProjects_Dashboard(sortedProjectsList, channelName, appName)}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function renderProjects_Dashboard(projectsList, channelName, appName) {
            let html = '';
            
            projectsList.forEach(project => {
                const tasks = project.tasks || [];
                const completedTasks = tasks.filter(t => t.completed).length;
                
                html += `
                    <div class="dashboard-project">
                        <div class="dashboard-project-header" onclick="toggleDashboardSection('project-${project.name}')">
                            <div style="flex: 1;">
                                <div class="dashboard-project-title">
                                    <span class="dashboard-expand-icon" id="icon-project-${project.name}">▶</span>
                                    📁 ${project.name}
                                    ${project.starred ? '⭐' : ''}
                                </div>
                                <div style="margin-left: 20px; margin-top: 4px; display: flex; gap: 12px; align-items: center; font-size: 12px;">
                                    <span class="project-status status-${project.status}" style="font-size: 11px; padding: 3px 8px;">
                                        ${project.status}
                                    </span>
                                    ${project.deliveryDate ? `<span style="color: #666;">📅 Delivery: ${(() => {
                                        const d = new Date(project.deliveryDate);
                                        const day = String(d.getDate()).padStart(2, '0');
                                        const month = String(d.getMonth() + 1).padStart(2, '0');
                                        const year = d.getFullYear();
                                        return day + '/' + month + '/' + year;
                                    })()}</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span class="dashboard-count">${completedTasks}/${tasks.length} tasks</span>
                            </div>
                        </div>
                        <div id="project-${project.name}" style="display: none;">
                            ${renderTasks_Dashboard(tasks, project.name)}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function renderProjectTimeline(project) {
            const tasks = project.tasks || [];
            const currentYear = new Date().getFullYear();
            
            // Get tasks with dates
            const tasksWithDates = tasks.filter(t => t.startDate || t.endDate);
            
            if (tasksWithDates.length === 0) {
                return '<div style="padding: 10px 20px; color: #a0aec0; font-size: 12px; font-style: italic;">No tasks with dates to show on timeline</div>';
            }
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const today = new Date();
            const todayMonth = today.getMonth();
            const todayDate = today.getDate();
            const todayPosition = (todayMonth + (todayDate / 30)) / 12 * 100;
            
            let html = `
                <div class="project-timeline">
                    <div class="timeline-header">
                        <div class="timeline-year">📅 ${currentYear} Timeline</div>
                        <div class="timeline-legend">
                            <div class="timeline-legend-item">
                                <div class="timeline-legend-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                                <span>In Progress</span>
                            </div>
                            <div class="timeline-legend-item">
                                <div class="timeline-legend-box" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);"></div>
                                <span>Completed</span>
                            </div>
                            <div class="timeline-legend-item">
                                <div class="timeline-legend-box" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);"></div>
                                <span>Overdue</span>
                            </div>
                            <div class="timeline-legend-item">
                                <div style="width: 2px; height: 12px; background: #ed8936;"></div>
                                <span>Today</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-grid">
                        <div class="timeline-label"></div>
                        ${months.map(month => `<div class="timeline-month">${month}</div>`).join('')}
                        
                        ${tasksWithDates.map((task, idx) => {
                            const startDate = task.startDate ? new Date(task.startDate) : null;
                            const endDate = task.endDate ? new Date(task.endDate) : null;
                            
                            let startMonth = 0;
                            let endMonth = 11;
                            
                            if (startDate && startDate.getFullYear() === currentYear) {
                                startMonth = startDate.getMonth() + (startDate.getDate() / 30);
                            }
                            if (endDate && endDate.getFullYear() === currentYear) {
                                endMonth = endDate.getMonth() + (endDate.getDate() / 30);
                            }
                            
                            const startPercent = (startMonth / 12) * 100;
                            const width = ((endMonth - startMonth) / 12) * 100;
                            
                            const isCompleted = task.completed;
                            const isOverdue = endDate && endDate < today && !task.completed;
                            const barClass = isCompleted ? 'completed' : (isOverdue ? 'overdue' : '');
                            
                            return `
                                <div class="timeline-label" title="${task.text}">
                                    ${task.text.substring(0, 15)}${task.text.length > 15 ? '...' : ''}
                                </div>
                                ${months.map((month, monthIdx) => {
                                    const isInRange = monthIdx >= Math.floor(startMonth) && monthIdx <= Math.ceil(endMonth);
                                    return `
                                        <div class="timeline-cell">
                                            ${isInRange && monthIdx === Math.floor(startMonth) ? `
                                                <div class="timeline-bar ${barClass}" 
                                                     style="left: ${(startMonth % 1) * 100}%; width: ${width}%;"
                                                     title="${task.text}
${task.assignee ? 'Assignee: ' + task.assignee : 'Unassigned'}
${startDate ? 'Start: ' + startDate.toLocaleDateString() : ''}
${endDate ? 'End: ' + endDate.toLocaleDateString() : ''}">
                                                    <span class="timeline-bar-label">${task.text}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="position: relative; height: 0;">
                        <div class="timeline-today" style="left: calc(80px + ${todayPosition}%);"></div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderTasks_Dashboard(tasks, projectName) {
            if (!tasks || tasks.length === 0) {
                return '<div style="padding: 10px 20px; color: #a0aec0; font-size: 13px;">No tasks in this project</div>';
            }
            
            // Sort tasks: incomplete first, completed at bottom
            const sortedTasks = tasks.sort((a, b) => {
                // Sort by completion status (incomplete = false comes first)
                if (!a.completed && b.completed) return -1;
                if (a.completed && !b.completed) return 1;
                
                // If both have same completion status, maintain relative order
                return 0;
            });
            
            let html = '';
            
            sortedTasks.forEach(task => {
                const icon = task.completed ? '✅' : '⏳';
                const assignee = task.assignee || 'Unassigned';
                const dates = task.startDate || task.endDate 
                    ? `<span class="dashboard-task-dates">
                        ${task.startDate ? new Date(task.startDate).toLocaleDateString() : '—'} → 
                        ${task.endDate ? new Date(task.endDate).toLocaleDateString() : '—'}
                      </span>`
                    : '';
                
                html += `
                    <div class="dashboard-task ${task.completed ? 'completed' : ''}">
                        <span class="dashboard-task-icon">${icon}</span>
                        <div class="dashboard-task-text">
                            ${task.text}
                            ${dates}
                        </div>
                        <span class="dashboard-task-assignee" style="${!task.assignee ? 'background: #cbd5e0; color: #4a5568;' : ''}">
                            ${assignee}
                        </span>
                    </div>
                `;
                
                // Render subtasks if any
                if (task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach(subtask => {
                        const subIcon = subtask.completed ? '✅' : '⏺';
                        const subAssignee = subtask.assignee || 'Unassigned';
                        
                        html += `
                            <div class="dashboard-task ${subtask.completed ? 'completed' : ''}" style="margin-left: 40px; font-size: 13px;">
                                <span class="dashboard-task-icon">${subIcon}</span>
                                <div class="dashboard-task-text">
                                    ${subtask.text}
                                </div>
                                <span class="dashboard-task-assignee" style="font-size: 11px; ${!subtask.assignee ? 'background: #cbd5e0; color: #4a5568;' : ''}">
                                    ${subAssignee}
                                </span>
                            </div>
                        `;
                    });
                }
            });
            
            return html;
        }

        function toggleDashboardSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById('icon-' + sectionId);
            
            if (section && icon) {
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    icon.classList.add('expanded');
                } else {
                    section.style.display = 'none';
                    icon.classList.remove('expanded');
                }
            }
        }

        function expandAllDashboard() {
            document.querySelectorAll('.dashboard-channel > div[id^="channel-"]').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.dashboard-application > div[id^="app-"]').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.dashboard-project > div[id^="project-"]').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.dashboard-expand-icon').forEach(icon => {
                icon.classList.add('expanded');
            });
        }

        function collapseAllDashboard() {
            document.querySelectorAll('.dashboard-channel > div[id^="channel-"]').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.dashboard-application > div[id^="app-"]').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.dashboard-project > div[id^="project-"]').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.dashboard-expand-icon').forEach(icon => {
                icon.classList.remove('expanded');
            });
        }

        async function exportDashboardPDF() {
            // Show loading message
            const originalButton = event.target;
            const originalText = originalButton.innerHTML;
            originalButton.innerHTML = '⏳ Generating PDF...';
            originalButton.disabled = true;
            
            try {
                // Expand all sections before export
                expandAllDashboard();
                
                // Wait for expansion animations to complete
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Create a temporary wrapper with only the timeline content
                const masterTimeline = document.getElementById('masterTimeline');
                const tempWrapper = document.createElement('div');
                tempWrapper.style.cssText = 'padding: 20px; background: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;';
                
                // Add title
                const title = document.createElement('h1');
                title.textContent = '📅 Master Project Timeline (Weekly View)';
                title.style.cssText = 'margin-bottom: 10px; color: #667eea; font-size: 28px;';
                tempWrapper.appendChild(title);
                
                // Add date
                const date = document.createElement('p');
                date.textContent = `Generated on: ${new Date().toLocaleString()}`;
                date.style.cssText = 'margin-bottom: 20px; color: #666; font-size: 14px;';
                tempWrapper.appendChild(date);
                
                // Clone and append timeline content
                const timelineClone = masterTimeline.cloneNode(true);
                tempWrapper.appendChild(timelineClone);
                
                // Temporarily add to document
                document.body.appendChild(tempWrapper);
                
                const { jsPDF } = window.jspdf;
                
                // Capture the temporary wrapper as canvas
                const canvas = await html2canvas(tempWrapper, {
                    scale: 1,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    allowTaint: true,
                    removeContainer: true,
                    imageTimeout: 0
                });
                
                // Remove temporary wrapper
                document.body.removeChild(tempWrapper);
                
                // Calculate PDF dimensions - use landscape for timeline
                const imgWidth = 297; // A4 landscape width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pageHeight = 210; // A4 landscape height in mm
                
                const pdf = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape
                
                // Convert canvas to image data with quality compression
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Add pages
                let position = 0;
                let heightLeft = imgHeight;
                
                // Add first page
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add additional pages if content is longer than one page
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Save the PDF
                const fileName = `Timeline_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                // Success message
                originalButton.innerHTML = '✅ PDF Downloaded!';
                setTimeout(() => {
                    originalButton.innerHTML = originalText;
                    originalButton.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Content may be too large. Try collapsing some sections first.');
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
            }
        }

        // Export/Import Functions
        function exportData() {
            // Normalize images to string format for export
            const normalizedProjects = projects.map(p => ({
                ...p,
                images: p.images ? p.images.map(img => 
                    typeof img === 'string' ? img : img.image_data
                ) : []
            }));
            
            const data = {
                teamMembers: teamMembers,
                projects: normalizedProjects,
                exportDate: new Date().toISOString(),
                version: "2.5.0"
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `it-resource-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Data exported successfully! Check your downloads folder.');
        }

        // Persist full client state to server backup endpoint
        async function persistData() {
            try {
                const payload = { teamMembers, projects, exportDate: new Date().toISOString(), version: '1.1' };
                await fetch('/api/backup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                console.error('Failed to persist data to server:', e);
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.teamMembers || !data.projects) {
                        alert('Invalid data file format! Expected teamMembers and projects.');
                        return;
                    }
                    
                    // Show import preview
                    const confirmMessage = `Import Data to PostgreSQL?\n\n` +
                        `Team Members: ${data.teamMembers.length}\n` +
                        `Projects: ${data.projects.length}\n` +
                        `Export Date: ${data.exportDate ? new Date(data.exportDate).toLocaleDateString() : 'Unknown'}\n\n` +
                        `⚠️ WARNING: This will REPLACE ALL data in the database!\n\n` +
                        `Click OK to proceed.`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // Show loading indicator
                    const loadingMsg = document.createElement('div');
                    loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 8px; z-index: 10000; font-size: 18px;';
                    loadingMsg.textContent = '⏳ Importing data to PostgreSQL...';
                    document.body.appendChild(loadingMsg);
                    
                    try {
                        // Send to PostgreSQL via API
                        const response = await fetch(`${API_BASE_URL}/api/import`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json' 
                            },
                            body: JSON.stringify(data)
                        });
                        
                        const result = await response.json();
                        
                        // Remove loading indicator
                        document.body.removeChild(loadingMsg);
                        
                        if (response.ok) {
                            // Reload data from server
                            await loadData();
                            
                            // Show success message
                            alert(`✅ Data imported successfully to PostgreSQL!\n\n` +
                                `Team Members: ${data.teamMembers.length}\n` +
                                `Projects: ${data.projects.length}\n` +
                                `Timestamp: ${result.timestamp || new Date().toISOString()}\n\n` +
                                `Database has been updated!`);
                        } else {
                            throw new Error(result.error || 'Import failed');
                        }
                        
                    } catch (apiError) {
                        // Remove loading indicator
                        if (document.body.contains(loadingMsg)) {
                            document.body.removeChild(loadingMsg);
                        }
                        
                        console.error('API import failed:', apiError);
                        
                        // Fallback: update local data and use persistData
                        if (confirm(`❌ Direct import to database failed: ${apiError.message}\n\n` +
                                   `Would you like to import locally and sync to server?\n\n` +
                                   `(This uses the backup endpoint instead)`)) {
                            
                            teamMembers.length = 0;
                            teamMembers.push(...data.teamMembers);
                            projects.length = 0;
                            projects.push(...data.projects);
                            
                            // Safely render all views
                            if (typeof renderTeam === 'function') renderTeam();
                            if (typeof renderProjects === 'function') renderProjects();
                            if (typeof renderTaskOverview === 'function') renderTaskOverview();
                            if (typeof renderCalendarView === 'function') renderCalendarView();
                            
                            // Try to persist to server
                            await persistData();
                            
                            alert(`⚠️ Data imported locally and synced to server via backup endpoint.\n\n` +
                                `Team Members: ${teamMembers.length}\n` +
                                `Projects: ${projects.length}`);
                        }
                    }
                    
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Initialize: Load data from server on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
        });
    </script>
</body>
</html>